<h2 mat-dialog-title>
  Add Garments
  @if (hasGarments()) {
    <span class="garment-count">{{ pendingGarments().length }} item{{ pendingGarments().length > 1 ? 's' : '' }}</span>
  }
</h2>

<mat-dialog-content>
  <!-- Upload Zone -->
  <div class="upload-zone" [class.has-items]="hasGarments()">
    <button mat-raised-button color="primary" class="smart-upload-button" (click)="fileInput.click()">
      <mat-icon>add_photo_alternate</mat-icon>
      {{ hasGarments() ? 'Add More' : 'Select Images' }}
    </button>
    <input #fileInput type="file" accept="image/*" multiple hidden (change)="handleFileSelection($event)">
    @if (!hasGarments()) {
      <p class="upload-hint">
        Select one or more garment images - we'll analyze each and suggest categories
      </p>
    }
  </div>

  <!-- Garment Queue -->
  @if (hasGarments()) {
    <div class="garment-queue">
      @for (garment of pendingGarments(); track garment.id) {
        <div class="garment-item" [class.saved]="garment.status === 'saved'" [class.error]="garment.status === 'error'">
          <!-- Preview Image -->
          <div class="garment-preview">
            <img [src]="getPreviewImage(garment)" alt="Garment preview">
            @if (garment.status === 'analyzing' || garment.status === 'saving') {
              <div class="preview-overlay">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            }
            @if (garment.status === 'saved') {
              <div class="preview-overlay success">
                <mat-icon>check_circle</mat-icon>
              </div>
            }
            @if (garment.status === 'error') {
              <div class="preview-overlay error">
                <mat-icon>error</mat-icon>
              </div>
            }
          </div>

          <!-- Garment Details -->
          <div class="garment-details">
            <!-- Status indicator -->
            @if (garment.status === 'analyzing') {
              <span class="status-text analyzing">Analyzing...</span>
            }
            @if (garment.status === 'saving') {
              <span class="status-text saving">Saving...</span>
            }
            @if (garment.status === 'saved') {
              <span class="status-text saved">Saved</span>
            }
            @if (garment.status === 'error') {
              <span class="status-text error">{{ garment.errorMessage }}</span>
            }

            <!-- Group & Category Selectors (when ready) -->
            @if (garment.status === 'ready') {
              <div class="category-selectors">
                <!-- Group Dropdown -->
                <mat-form-field appearance="outline" class="group-select">
                  <mat-label>Group</mat-label>
                  <mat-select
                    [value]="garment.selectedGroup"
                    (selectionChange)="updateGroup(garment.id, $event.value)">
                    @for (group of uniqueGroups(); track group) {
                      <mat-option [value]="group">{{ getGroupDisplayName(group) }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>

                <!-- Category Dropdown (filtered by group) -->
                <mat-form-field appearance="outline" class="category-select">
                  <mat-label>Category</mat-label>
                  <mat-select
                    [value]="garment.selectedCategoryId"
                    (selectionChange)="updateCategory(garment.id, $event.value)"
                    [disabled]="!garment.selectedGroup">
                    @for (cat of getCategoriesForGroup(garment.selectedGroup); track categoryId(cat)) {
                      <mat-option [value]="categoryId(cat)">{{ categoryLabel(cat) }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              </div>
            }
          </div>

          <!-- Actions -->
          <div class="garment-actions">
            @if (garment.status === 'error') {
              <button mat-icon-button (click)="retryAnalysis(garment.id)" matTooltip="Retry">
                <mat-icon>refresh</mat-icon>
              </button>
            }
            @if (garment.status !== 'saving' && garment.status !== 'saved') {
              <button mat-icon-button (click)="removeGarment(garment.id)" matTooltip="Remove">
                <mat-icon>close</mat-icon>
              </button>
            }
          </div>
        </div>
      }
    </div>

    <!-- Progress Summary -->
    @if (analyzingCount() > 0) {
      <div class="progress-summary">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <span>Analyzing {{ analyzingCount() }} garment{{ analyzingCount() > 1 ? 's' : '' }}...</span>
      </div>
    }
  }
</mat-dialog-content>

<mat-dialog-actions align="end">
  @if (hasGarments() && !isSavingAll()) {
    <button mat-button (click)="clearAll()">
      <mat-icon>delete_sweep</mat-icon> Clear All
    </button>
  }
  <button mat-button (click)="cancel()">
    {{ savedCount() > 0 ? 'Done' : 'Cancel' }}
  </button>
  @if (readyCount() > 0) {
    <button mat-raised-button color="primary"
            [disabled]="isSavingAll()"
            (click)="saveAll()">
      @if (isSavingAll()) {
        <mat-icon class="spinning">sync</mat-icon> Saving...
      } @else {
        <mat-icon>save</mat-icon>
        Save {{ readyCount() }} Garment{{ readyCount() > 1 ? 's' : '' }}
      }
    </button>
  }
</mat-dialog-actions>
