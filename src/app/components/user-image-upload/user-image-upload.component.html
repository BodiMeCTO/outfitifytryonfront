<section class="section-card user-image-upload">
  <div class="cards-container">
    <!-- MODEL IMAGE CARD -->
    <mat-card appearance="outlined" class="model-card">
      <mat-card-header>
        <mat-card-title>Choose or upload an image of the person</mat-card-title>
        <mat-card-subtitle>
          Pick a photo of the person you want to see trying on clothes or in the outfits you create.
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <!-- EXISTING USER IMAGES -->
        <div class="existing-images" *ngIf="userImages$ | async as userImages">
          <h3 class="section-title">Use a saved photo</h3>

          <div *ngIf="userImages.length; else noSavedImages" class="image-grid">
            <button
              mat-stroked-button
              type="button"
              class="image-tile"
              *ngFor="let img of userImages"
              (click)="selectExisting(img)"
              [class.is-selected]="(inspiration$ | async)?.id === img.id"
            >
              <img
                [src]="img.previewUrl || img.remoteUrl"
                alt="Saved model photo"
              />
            </button>
          </div>

          <ng-template #noSavedImages>
            <p class="hint">
              You don't have any saved photos yet. Upload one to get started.
            </p>
          </ng-template>
        </div>

        <!-- UPLOAD NEW IMAGE -->
        <div class="upload-zone">
          <input
            #fileInput
            type="file"
            accept="image/*"
            (change)="handleFileSelection($event)"
            hidden
          />
          <button
            mat-raised-button
            color="primary"
            (click)="fileInput.click()"
            [disabled]="isUploading()"
          >
            <mat-icon>photo_library</mat-icon>
            {{ isUploading() ? 'Uploading…' : 'Upload a new photo' }}
          </button>
          <p class="hint">
            For this proof of concept, your image is only used for generating outfits.
          </p>
          <mat-progress-bar *ngIf="isUploading()" mode="indeterminate"></mat-progress-bar>
        </div>

        <!-- CURRENT SELECTION PREVIEW -->
        <div class="preview" *ngIf="inspiration$ | async as inspiration">
          <img
            [src]="inspiration.previewUrl || inspiration.remoteUrl"
            alt="Selected user image"
          />
          <div class="actions">
            <button mat-button type="button" (click)="clearSelection()">Remove</button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- BACKGROUND IMAGE CARD -->
    <mat-card appearance="outlined" class="background-card">
      <mat-card-header>
        <mat-card-title>Choose or upload a background image</mat-card-title>
        <mat-card-subtitle>
          Optional: pick or upload a background to place behind your outfits.
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <!-- EXISTING BACKGROUNDS -->
        <div class="existing-images" *ngIf="backgroundOptions$ | async as options">
          <h3 class="section-title">Use a saved background</h3>

          <div *ngIf="options.length; else noOptions" class="image-grid">
            <button
              mat-stroked-button
              type="button"
              class="image-tile"
              *ngFor="let option of options"
              (click)="selectExistingBackground(option)"
              [class.is-selected]="(selectedBackground$ | async)?.id === option.id"
            >
              <ng-container *ngIf="option.thumbnailUrl; else nameOnly">
                <img [src]="option.thumbnailUrl" [alt]="option.name || 'Background option'" />
              </ng-container>
              <ng-template #nameOnly>
                <span class="placeholder">{{ option.name || 'Background' }}</span>
              </ng-template>
            </button>
          </div>

          <ng-template #noOptions>
            <p class="hint">No saved backgrounds yet. Upload one to customise your scene.</p>
          </ng-template>
        </div>

        <!-- UPLOAD NEW BACKGROUND -->
        <div class="upload-zone">
          <input
            #bgFileInput
            type="file"
            accept="image/*"
            (change)="handleBackgroundFileSelection($event)"
            hidden
          />
          <button
            mat-raised-button
            color="primary"
            (click)="bgFileInput.click()"
            [disabled]="isUploadingBackground()"
          >
            <mat-icon>photo_library</mat-icon>
            {{ isUploadingBackground() ? 'Uploading…' : 'Upload a new background' }}
          </button>
          <p class="hint">
            Backgrounds are optional. You can upload a new one or skip this step.
          </p>
          <mat-progress-bar *ngIf="isUploadingBackground()" mode="indeterminate"></mat-progress-bar>
        </div>

        <!-- CURRENT BACKGROUND PREVIEW -->
        <div class="preview" *ngIf="selectedBackground$ | async as selected">
          <ng-container *ngIf="selected.thumbnailUrl; else previewNameOnly">
            <img [src]="selected.thumbnailUrl" [alt]="selected.name || 'Selected background'" />
          </ng-container>
          <ng-template #previewNameOnly>
            <div class="name-preview">
              <mat-icon>image</mat-icon>
              <div>
                <p class="label">Selected background</p>
                <p class="name">{{ selected.name || 'Background' }}</p>
              </div>
            </div>
          </ng-template>
          <div class="actions">
            <button mat-button type="button" (click)="clearBackgroundSelection()">Remove</button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- CONTINUE BUTTON -->
  <div class="continue-actions" *ngIf="inspiration$ | async">
    <button mat-raised-button color="primary" routerLink="/garment-library">
      Continue to garments
    </button>
  </div>
</section>
