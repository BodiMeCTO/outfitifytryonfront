<section class="section-card user-image-upload">
  <!-- PAGE NAVIGATION -->
  <div class="page-nav">
    <button mat-button routerLink="/generated-gallery" class="back-button">
      <mat-icon>arrow_back</mat-icon>
      Back to Gallery
    </button>
    <span class="step-indicator">Step 1 of 3</span>
  </div>

  <div class="cards-container">
    <!-- MODEL IMAGE CARD -->
    <mat-card appearance="outlined" class="model-card">
      <mat-card-header>
        <mat-card-title>Choose or upload an image of the person</mat-card-title>
        <mat-card-subtitle>
          Pick a photo of the person you want to see trying on clothes or in the outfits you create.
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <!-- EXISTING USER IMAGES -->
        <div class="existing-images" *ngIf="userImages$ | async as userImages">
          <h3 class="section-title">Use a saved photo</h3>

          <div *ngIf="userImages.length; else noSavedImages" class="image-grid">
            <button
              mat-stroked-button
              type="button"
              class="image-tile"
              *ngFor="let img of userImages"
              (click)="selectExisting(img)"
              [class.is-selected]="(inspiration$ | async)?.id === img.id"
            >
              <img
                [src]="img.previewUrl || img.remoteUrl"
                alt="Saved model photo"
              />
            </button>
          </div>

          <ng-template #noSavedImages>
            <p class="hint">
              You don't have any saved photos yet. Upload one to get started.
            </p>
          </ng-template>
        </div>

        <!-- UPLOAD NEW IMAGE -->
        <div class="upload-zone">
          <input
            #fileInput
            type="file"
            accept="image/*"
            (change)="handleFileSelection($event)"
            hidden
          />
          <button
            mat-raised-button
            color="primary"
            (click)="fileInput.click()"
            [disabled]="isUploading()"
          >
            <mat-icon>photo_library</mat-icon>
            {{ isUploading() ? 'Uploadingâ€¦' : 'Upload a new photo' }}
          </button>
          <p class="hint">
            For this proof of concept, your image is only used for generating outfits.
          </p>
          <mat-progress-bar *ngIf="isUploading()" mode="indeterminate"></mat-progress-bar>
        </div>

        <!-- CURRENT SELECTION PREVIEW -->
        <div class="preview" *ngIf="inspiration$ | async as inspiration">
          <img
            [src]="inspiration.previewUrl || inspiration.remoteUrl"
            alt="Selected user image"
          />
          <div class="actions">
            <button mat-button type="button" (click)="clearSelection()">Remove</button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- BACKGROUND IMAGE CARD -->
    <mat-card appearance="outlined" class="background-card">
      <mat-card-header>
        <mat-card-title>Choose a background scene</mat-card-title>
        <mat-card-subtitle>
          Select a preset background or describe your own custom scene.
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <!-- TEMPLATE BACKGROUNDS -->
        <div class="existing-images" *ngIf="templateBackgrounds$ | async as templates">
          <h3 class="section-title">Background Options</h3>

          <div class="image-grid">
            <!-- Keep Original option (default) -->
            <button
              mat-stroked-button
              type="button"
              class="image-tile template-tile"
              (click)="selectKeepOriginal()"
              [class.is-selected]="isKeepOriginal()"
            >
              <mat-icon class="template-icon">person</mat-icon>
              <span class="template-name">Keep Original</span>
            </button>

            <button
              mat-stroked-button
              type="button"
              class="image-tile template-tile"
              *ngFor="let template of templates"
              (click)="selectExistingBackground(template)"
              [class.is-selected]="(selectedBackground$ | async)?.id === template.id && !isCustomMode() && !isKeepOriginal()"
            >
              <mat-icon class="template-icon">{{ getTemplateIcon(template.name) }}</mat-icon>
              <span class="template-name">{{ template.name }}</span>
            </button>

            <!-- Custom option -->
            <button
              mat-stroked-button
              type="button"
              class="image-tile template-tile custom-tile"
              (click)="selectCustomMode()"
              [class.is-selected]="isCustomMode()"
            >
              <mat-icon class="template-icon">edit</mat-icon>
              <span class="template-name">Custom</span>
            </button>
          </div>
        </div>

        <!-- CUSTOM PROMPT INPUT -->
        <div class="custom-prompt-section" *ngIf="isCustomMode()">
          <mat-form-field appearance="outline" class="custom-prompt-field">
            <mat-label>Describe your background</mat-label>
            <textarea
              matInput
              [(ngModel)]="customPromptValue"
              placeholder="e.g., 'tropical beach at sunset with palm trees' or 'modern minimalist living room'"
              rows="3"
            ></textarea>
            <mat-hint>Be descriptive for best results</mat-hint>
          </mat-form-field>
          <button
            mat-raised-button
            color="primary"
            (click)="applyCustomPrompt()"
            [disabled]="!customPromptValue.trim()"
            class="apply-button"
          >
            <mat-icon>check</mat-icon>
            Apply Custom Background
          </button>
        </div>

        <!-- Keep Original preview -->
        <div class="preview" *ngIf="isKeepOriginal()">
          <div class="name-preview">
            <mat-icon>person</mat-icon>
            <div>
              <p class="label">Selected background</p>
              <p class="name">Keep Original</p>
              <p class="prompt-hint">Uses the background from your uploaded photo</p>
            </div>
          </div>
        </div>

        <!-- CURRENT SELECTION PREVIEW -->
        <div class="preview" *ngIf="!isKeepOriginal() && !isCustomMode() && (selectedBackground$ | async) as selected">
          <div class="name-preview">
            <mat-icon>{{ getTemplateIcon(selected.name) }}</mat-icon>
            <div>
              <p class="label">Selected background</p>
              <p class="name">{{ selected.name || 'Background' }}</p>
              <p class="prompt-hint" *ngIf="selected.prompt">{{ selected.prompt }}</p>
            </div>
          </div>
          <div class="actions">
            <button mat-button type="button" (click)="clearBackgroundSelection()">Remove</button>
          </div>
        </div>

        <!-- Custom prompt selection preview -->
        <div class="preview" *ngIf="isCustomMode() && (customPrompt$ | async) as prompt">
          <div class="name-preview">
            <mat-icon>edit</mat-icon>
            <div>
              <p class="label">Custom background</p>
              <p class="prompt-hint">{{ prompt }}</p>
            </div>
          </div>
          <div class="actions">
            <button mat-button type="button" (click)="clearBackgroundSelection()">Remove</button>
          </div>
        </div>

        <!-- ASPECT RATIO SELECTION - only shown when a background is selected -->
        <div class="aspect-ratio-section" *ngIf="!isKeepOriginal()">
          <h3 class="section-title">Output Aspect Ratio</h3>
          <p class="section-hint">Choose the aspect ratio for your final image</p>

          <div class="aspect-ratio-grid">
            <button
              mat-stroked-button
              type="button"
              class="aspect-ratio-tile"
              *ngFor="let option of aspectRatioOptions"
              (click)="selectAspectRatio(option.value)"
              [class.is-selected]="(selectedAspectRatio$ | async) === option.value"
            >
              <mat-icon class="ratio-icon">aspect_ratio</mat-icon>
              <span class="ratio-label">{{ option.label }}</span>
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- CONTINUE BUTTON -->
  <div class="continue-actions" *ngIf="inspiration$ | async">
    <button mat-raised-button color="primary" routerLink="/garment-library">
      Continue to garments
    </button>
  </div>
</section>
