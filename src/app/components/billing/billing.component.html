<section class="billing-page">
  <div class="page-nav">
    <button mat-icon-button (click)="goBack()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>Billing & Credits</h1>
  </div>

  <mat-progress-bar *ngIf="isLoading() || isProcessing()" mode="indeterminate"></mat-progress-bar>

  <!-- Current Status Card -->
  <mat-card appearance="outlined" class="status-card">
    <mat-card-header>
      <mat-card-title>Your Account</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="status-grid">
        <div class="status-item">
          <mat-icon>toll</mat-icon>
          <span class="value">{{ balance() ?? '...' }}</span>
          <span class="label">Credits Available</span>
        </div>
        <div class="status-item" *ngIf="currentSubscription()?.planName">
          <mat-icon>card_membership</mat-icon>
          <span class="value">{{ currentSubscription()?.planName }}</span>
          <span class="label">Current plan ({{ currentSubscription()?.isAnnual ? 'Annual' : 'Monthly' }})</span>
        </div>
        <div class="status-item" *ngIf="currentSubscription()?.priceAmount">
          <mat-icon>payments</mat-icon>
          <span class="value">${{ currentSubscription()?.priceAmount }}</span>
          <span class="label">{{ currentSubscription()?.isAnnual ? 'per year' : 'per month' }}</span>
        </div>
        <div class="status-item" *ngIf="currentSubscription()?.currentPeriodStart">
          <mat-icon>event_available</mat-icon>
          <span class="value">{{ currentSubscription()?.currentPeriodStart | date:'mediumDate' }}</span>
          <span class="label">Current Period Started</span>
        </div>
        <div class="status-item" *ngIf="currentSubscription()?.currentPeriodEnd">
          <mat-icon>event</mat-icon>
          <span class="value">{{ currentSubscription()?.currentPeriodEnd | date:'mediumDate' }}</span>
          <span class="label">{{ currentSubscription()?.isAnnual ? 'Next Annual Renewal' : 'Next Billing Date' }}</span>
        </div>
        <div class="status-item" *ngIf="currentSubscription()?.monthlyCredits">
          <mat-icon>add_circle</mat-icon>
          <span class="value">{{ currentSubscription()?.monthlyCredits }}</span>
          <span class="label">Credits per Month</span>
        </div>
      </div>
    </mat-card-content>
    <mat-card-actions *ngIf="currentSubscription()?.subscriptionId">
      <button mat-stroked-button (click)="manageSubscription()">
        <mat-icon>settings</mat-icon>
        Manage subscription
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Billing Type Selector -->
  <div class="billing-type-selector">
    <button
      class="billing-type-btn"
      [class.active]="selectedBillingType() === 'annual'"
      (click)="selectedBillingType.set('annual')"
    >
      <mat-icon class="best-value-icon">star</mat-icon>
      <span class="btn-label">Annual</span>
      <span class="btn-sublabel">Save 20%</span>
    </button>
    <button
      class="billing-type-btn"
      [class.active]="selectedBillingType() === 'monthly'"
      (click)="selectedBillingType.set('monthly')"
    >
      <span class="btn-label">Monthly</span>
      <span class="btn-sublabel">Flexible</span>
    </button>
    <button
      class="billing-type-btn"
      [class.active]="selectedBillingType() === 'payg'"
      (click)="selectedBillingType.set('payg')"
    >
      <span class="btn-label">Pay as you go</span>
      <span class="btn-sublabel">No commitment</span>
    </button>
  </div>

  <!-- Annual/Monthly Subscription Plans -->
  <div class="billing-content" *ngIf="selectedBillingType() === 'annual' || selectedBillingType() === 'monthly'">
    <div class="content-header">
      <h3>{{ selectedBillingType() === 'annual' ? 'Annual' : 'Monthly' }} Subscription Plans</h3>
      <p class="content-description">
        {{ selectedBillingType() === 'annual'
          ? 'Best value! Pay annually and save 20% on all plans.'
          : 'Pay monthly with the flexibility to cancel anytime.' }}
      </p>
    </div>

    <div class="plans-grid">
      <mat-card *ngFor="let plan of plans()"
                appearance="outlined"
                class="plan-card"
                [class.current]="currentSubscription()?.planName === plan.name && currentSubscription()?.isAnnual === (selectedBillingType() === 'annual')">
        <mat-card-header>
          <mat-card-title>{{ plan.name }}</mat-card-title>
          <mat-chip *ngIf="currentSubscription()?.planName === plan.name && currentSubscription()?.isAnnual === (selectedBillingType() === 'annual')" class="current-badge">Current</mat-chip>
        </mat-card-header>

        <mat-card-content>
          <div class="price">
            <span class="amount">${{ selectedBillingType() === 'annual' ? plan.annualPrice : plan.monthlyPrice }}</span>
            <span class="period">/{{ selectedBillingType() === 'annual' ? 'year' : 'month' }}</span>
          </div>

          <div class="savings" *ngIf="selectedBillingType() === 'annual' && getAnnualSavings(plan) > 0">
            Save ${{ getAnnualSavings(plan) }}/year
          </div>

          <ul class="features">
            <li>
              <mat-icon>check</mat-icon>
              {{ plan.monthlyCredits }} credits/month
            </li>
            <li>
              <mat-icon>check</mat-icon>
              {{ plan.monthlyCredits * 12 }} credits/year total
            </li>
            <li *ngIf="plan.description">
              <mat-icon>check</mat-icon>
              {{ plan.description }}
            </li>
          </ul>
        </mat-card-content>

        <mat-card-actions>
          <button mat-raised-button
                  color="primary"
                  *ngIf="!currentSubscription()?.subscriptionId || currentSubscription()?.planName !== plan.name || currentSubscription()?.isAnnual !== (selectedBillingType() === 'annual')"
                  [disabled]="isProcessing()"
                  (click)="selectPlan(plan)">
            {{ currentSubscription()?.subscriptionId ? 'Switch plan' : 'Subscribe' }}
          </button>
          <button mat-raised-button
                  *ngIf="currentSubscription()?.subscriptionId && currentSubscription()?.planName === plan.name && currentSubscription()?.isAnnual === (selectedBillingType() === 'annual')"
                  disabled>
            Current plan
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>

  <!-- Pay As You Go Credit Packages -->
  <div class="billing-content" *ngIf="selectedBillingType() === 'payg'">
    <div class="content-header">
      <h3>Credit Packages</h3>
      <p class="content-description">
        No subscription needed. Buy credits when you need them - they never expire.
      </p>
    </div>

    <div class="packages-grid">
      <mat-card *ngFor="let pkg of packages(); let i = index"
                appearance="outlined"
                class="package-card"
                [class.popular]="i === 1">
        <div class="package-badge" *ngIf="i === 1">Most Popular</div>
        <mat-card-header>
          <mat-card-title>{{ pkg.name }}</mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <div class="credits">
            <span class="amount">{{ pkg.credits }}</span>
            <span class="label">credits</span>
          </div>

          <div class="price">
            <span class="amount">${{ pkg.price.toFixed(2) }}</span>
          </div>

          <div class="per-credit">
            ${{ pkg.pricePerCredit.toFixed(2) }} per credit
          </div>

          <div class="package-info" *ngIf="pkg.credits >= 50">
            <mat-icon>info</mat-icon>
            <span>Best value for regular users</span>
          </div>
        </mat-card-content>

        <mat-card-actions>
          <button mat-raised-button
                  [color]="i === 1 ? 'primary' : 'accent'"
                  [disabled]="isProcessing()"
                  (click)="purchasePackage(pkg)">
            Buy now
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>
</section>
