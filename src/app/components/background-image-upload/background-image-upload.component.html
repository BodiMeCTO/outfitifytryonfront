<section class="section-card background-upload">
  <mat-card appearance="outlined">
    <mat-card-header>
      <mat-card-title>Choose a background scene</mat-card-title>
      <mat-card-subtitle>
        Select a preset background or describe your own custom scene.
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- TEMPLATE BACKGROUNDS -->
      <div class="template-backgrounds" *ngIf="templateBackgrounds$ | async as templates">
        <h3 class="section-title">AI-Generated Backgrounds</h3>

        <div *ngIf="templates.length" class="template-grid">
          <button
            mat-stroked-button
            type="button"
            class="template-tile"
            *ngFor="let template of templates"
            (click)="selectExisting(template)"
            [class.is-selected]="(selectedBackground$ | async)?.id === template.id && !isCustomMode()"
          >
            <mat-icon class="template-icon">{{ getTemplateIcon(template.name) }}</mat-icon>
            <span class="template-name">{{ template.name }}</span>
          </button>

          <!-- Custom option -->
          <button
            mat-stroked-button
            type="button"
            class="template-tile custom-tile"
            (click)="selectCustomMode()"
            [class.is-selected]="isCustomMode()"
          >
            <mat-icon class="template-icon">edit</mat-icon>
            <span class="template-name">Custom</span>
          </button>
        </div>
      </div>

      <!-- CUSTOM PROMPT INPUT -->
      <div class="custom-prompt-section" *ngIf="isCustomMode()">
        <mat-form-field appearance="outline" class="custom-prompt-field">
          <mat-label>Describe your background</mat-label>
          <textarea
            matInput
            [(ngModel)]="customPromptValue"
            placeholder="e.g., 'tropical beach at sunset with palm trees' or 'modern minimalist living room'"
            rows="3"
          ></textarea>
          <mat-hint>Be descriptive for best results</mat-hint>
        </mat-form-field>
        <button
          mat-raised-button
          color="primary"
          (click)="applyCustomPrompt()"
          [disabled]="!customPromptValue.trim()"
          class="apply-button"
        >
          <mat-icon>check</mat-icon>
          Apply Custom Background
        </button>
      </div>

      <!-- CURRENT SELECTION PREVIEW -->
      <div class="preview" *ngIf="(selectedBackground$ | async) as selected">
        <div class="selection-preview">
          <mat-icon class="preview-icon">{{ getTemplateIcon(selected.name) }}</mat-icon>
          <div class="preview-info">
            <p class="label">Selected background</p>
            <p class="name">{{ selected.name || 'Background' }}</p>
            <p class="prompt-hint" *ngIf="selected.prompt">{{ selected.prompt }}</p>
          </div>
        </div>

        <div class="actions">
          <button mat-stroked-button color="primary" routerLink="/garment-library">
            Continue to garments
          </button>
          <button mat-button routerLink="/user-image-upload" type="button">
            Back to model upload
          </button>
          <button mat-button type="button" (click)="clearSelection()">Remove</button>
        </div>
      </div>

      <!-- Custom prompt selection preview -->
      <div class="preview" *ngIf="isCustomMode() && (customPrompt$ | async) as prompt">
        <div class="selection-preview">
          <mat-icon class="preview-icon">edit</mat-icon>
          <div class="preview-info">
            <p class="label">Custom background</p>
            <p class="prompt-hint">{{ prompt }}</p>
          </div>
        </div>

        <div class="actions">
          <button mat-stroked-button color="primary" routerLink="/garment-library">
            Continue to garments
          </button>
          <button mat-button routerLink="/user-image-upload" type="button">
            Back to model upload
          </button>
          <button mat-button type="button" (click)="clearSelection()">Remove</button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</section>
