<section class="section-card image-review">
  <!-- Back to gallery Header -->
  <header class="review-header">
    <button class="back-to-gallery-btn" routerLink="/generated-gallery">
      <mat-icon>arrow_back</mat-icon>
      <span>Back to gallery</span>
    </button>
  </header>

  <ng-container *ngIf="image() as current">
    <!-- Zoomable preview (#22) -->
    <figure class="preview" [class.zoomed]="isZoomed()" (click)="toggleZoom()">
      <img [src]="displayImageUrl()" alt="Selected generated outfit" />
      <div class="zoom-hint" *ngIf="!isZoomed()">
        <mat-icon>zoom_in</mat-icon>
        <span>Tap to zoom</span>
      </div>
    </figure>

    <!-- AI Disclaimer -->
    <app-ai-disclaimer variant="compact"></app-ai-disclaimer>

    <!-- Variant thumbnails (only show if there are multiple variants) -->
    <div class="variants-strip" *ngIf="hasVariants()">
      <span class="variants-label">Versions:</span>
      <div class="variants-list">
        <button
          *ngFor="let variant of current.variants; let i = index"
          class="variant-thumb"
          [class.selected]="selectedVariantIndex() === i"
          (click)="selectVariant(i)"
          [matTooltip]="getVariantLabel(variant, i)"
        >
          <img [src]="variant.imageUrl" [alt]="getVariantLabel(variant, i)" />
          <span class="variant-badge" *ngIf="variant.editType">
            <mat-icon>{{ variant.editType === 'upscaled' ? 'zoom_in' : variant.editType === 'filtered' ? 'tune' : 'auto_fix_high' }}</mat-icon>
          </span>
        </button>
      </div>
    </div>

    <!-- Input details - what was used to create this outfit -->
    <div class="input-details" *ngIf="current.modelImageUrl || current.poseName || current.backgroundName || (current.garments && current.garments.length > 0)">
      <div class="input-header">
        <mat-icon>info_outline</mat-icon>
        <span>Created with</span>
      </div>
      <div class="input-content">
        <!-- Model thumbnail -->
        <img
          *ngIf="current.modelImageUrl"
          [src]="current.modelImageUrl"
          alt="Model"
          class="input-model-thumb"
          matTooltip="Model image"
        />
        <!-- Details column -->
        <div class="input-info">
          <!-- Settings tags -->
          <div class="input-settings" *ngIf="current.poseName || current.backgroundName || current.aspectRatio">
            <span *ngIf="current.poseName" class="input-tag">
              <mat-icon>accessibility_new</mat-icon>
              {{ current.poseName }}
            </span>
            <span *ngIf="current.backgroundName" class="input-tag">
              <mat-icon>wallpaper</mat-icon>
              {{ current.backgroundName }}
            </span>
            <span *ngIf="current.aspectRatio && current.aspectRatio !== 'original'" class="input-tag">
              <mat-icon>aspect_ratio</mat-icon>
              {{ current.aspectRatio }}
            </span>
          </div>
          <!-- Garments row -->
          <div class="input-garments" *ngIf="current.garments && current.garments.length > 0">
            <img
              *ngFor="let garment of current.garments"
              [src]="garment.imageUrl"
              [alt]="garment.name"
              class="input-garment-thumb"
              [matTooltip]="garment.name + (garment.category ? ' (' + garment.category + ')' : '')"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Videos section -->
    <div class="videos-section" *ngIf="videos().length > 0">
      <div class="videos-header">
        <mat-icon>videocam</mat-icon>
        <span>Videos ({{ videos().length }})</span>
      </div>
      <div class="videos-list">
        <div class="video-card" *ngFor="let video of videos()">
          <video
            class="video-player"
            [src]="getVideoUrl(video)"
            controls
            playsinline
            preload="metadata"
          ></video>
          <div class="video-info">
            <div class="video-specs">
              <span class="video-spec">
                <mat-icon>timer</mat-icon>
                {{ formatDuration(video.durationSeconds) }}
              </span>
              <span class="video-spec">
                <mat-icon>high_quality</mat-icon>
                {{ video.resolution }}
              </span>
              <span class="video-spec" *ngIf="video.fileSizeBytes">
                <mat-icon>storage</mat-icon>
                {{ formatFileSize(video.fileSizeBytes) }}
              </span>
            </div>
            <button class="video-download-btn" (click)="downloadVideo(video)" matTooltip="Download video">
              <mat-icon>download</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button class="nav-btn" (click)="navigate(-1)" aria-label="Previous image">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <button class="nav-btn" (click)="navigate(1)" aria-label="Next image">
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>

    <!-- Desktop actions (hidden on mobile) -->
    <div class="actions desktop-actions">
      <button class="action-btn primary" (click)="share()">
        <mat-icon>ios_share</mat-icon>
        Share
      </button>
      <button class="action-btn" (click)="redo()" *ngIf="current.status === 'ready'" matTooltip="Create a new outfit with the same settings">
        <mat-icon>replay</mat-icon>
        Redo
      </button>
      <button class="action-btn" (click)="openAddGarmentsDialog()" *ngIf="current.status === 'ready'" matTooltip="Add more items to this outfit">
        <mat-icon>add_circle</mat-icon>
        Add Items
      </button>
      <button class="action-btn" (click)="openVideoDialog()">
        <mat-icon>videocam</mat-icon>
        Video
      </button>
      <button class="action-btn" (click)="openEditDialog()">
        <mat-icon>auto_fix_high</mat-icon>
        Enhance
      </button>
      <button class="action-btn" (click)="download()">
        <mat-icon>download</mat-icon>
        Download
      </button>
      <button class="action-btn" (click)="downloadWithWatermark()" matTooltip="Download with OUTFITIFY.AI watermark">
        <mat-icon>verified</mat-icon>
        With watermark
      </button>
      <button class="action-btn" (click)="archive()">
        <mat-icon>inventory_2</mat-icon>
        Archive
      </button>
      <button class="action-btn secondary" (click)="goToGallery()">
        <mat-icon>grid_view</mat-icon>
        Gallery
      </button>
    </div>

    <!-- Mobile bottom action bar (fixed, 6 buttons for ready outfits, 5 otherwise) -->
    <div class="mobile-action-bar">
      <button class="mobile-action-btn" (click)="share()">
        <mat-icon>ios_share</mat-icon>
        <span>Share</span>
      </button>
      <button class="mobile-action-btn" (click)="redo()" *ngIf="current.status === 'ready'">
        <mat-icon>replay</mat-icon>
        <span>Redo</span>
      </button>
      <button class="mobile-action-btn" (click)="openAddGarmentsDialog()" *ngIf="current.status === 'ready'">
        <mat-icon>add_circle</mat-icon>
        <span>Add</span>
      </button>
      <button class="mobile-action-btn" (click)="openVideoDialog()">
        <mat-icon>videocam</mat-icon>
        <span>Video</span>
      </button>
      <button class="mobile-action-btn" (click)="download()">
        <mat-icon>download</mat-icon>
        <span>Save</span>
      </button>
      <button class="mobile-action-btn" (click)="openEditDialog()">
        <mat-icon>auto_fix_high</mat-icon>
        <span>Enhance</span>
      </button>
      <button class="mobile-action-btn" (click)="archive()">
        <mat-icon>inventory_2</mat-icon>
        <span>Archive</span>
      </button>
    </div>
  </ng-container>
</section>
