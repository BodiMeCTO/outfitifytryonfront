<h2 mat-dialog-title>Edit Background</h2>

<mat-dialog-content>
  <!-- Processing State -->
  @if (isProcessing()) {
    <div class="processing-state">
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      <p>Generating new background...</p>
      <p class="processing-hint">This may take a moment</p>
    </div>
  }

  <!-- Loading State -->
  @if (isLoadingPresets()) {
    <div class="loading-state">
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      <p>Loading background options...</p>
    </div>
  }

  <!-- Main Form -->
  @if (!isProcessing() && !isLoadingPresets()) {
    <div class="edit-form">
      <!-- Source Image Preview -->
      <div class="source-preview">
        <img [src]="data.sourceImageUrl" alt="Source image" class="preview-image">
        @if (data.sourceName) {
          <p class="source-name">{{ data.sourceName }}</p>
        }
      </div>

      <!-- Background Selection -->
      <div class="background-section">
        <p class="section-label">Background</p>

        <!-- Preset Options Grid -->
        <div class="background-options">
          @for (preset of backgroundPresets(); track preset.backgroundImageId) {
            <button type="button"
                    class="background-tile"
                    [class.selected]="isPresetSelected(preset.backgroundImageId)"
                    (click)="selectPreset(preset.backgroundImageId)">
              @if (preset.imageUrl) {
                <img [src]="preset.imageUrl" [alt]="preset.name" class="preset-thumbnail">
              } @else {
                <mat-icon>wallpaper</mat-icon>
              }
              <span class="preset-name">{{ preset.name }}</span>
            </button>
          }

          <!-- Custom Prompt Option -->
          <button type="button"
                  class="background-tile custom-tile"
                  [class.selected]="isCustomMode()"
                  (click)="selectCustomMode()">
            <mat-icon>edit</mat-icon>
            <span class="preset-name">Custom</span>
          </button>
        </div>

        <!-- Custom Prompt Input (only shown in custom mode) -->
        @if (isCustomMode()) {
          <mat-form-field appearance="outline" class="full-width custom-prompt-field">
            <mat-label>Background Description</mat-label>
            <textarea matInput
                      rows="3"
                      placeholder="Describe the background you want, e.g., 'professional photography studio with soft neutral lighting'"
                      [value]="customPrompt()"
                      (input)="customPrompt.set($any($event.target).value)"></textarea>
            <mat-hint>Be descriptive for best results</mat-hint>
          </mat-form-field>
        }
      </div>

      <!-- Aspect Ratio Selection -->
      <div class="aspect-ratio-section">
        <p class="section-label">Aspect Ratio</p>
        <div class="aspect-ratio-options">
          @for (option of aspectRatioOptions; track option.value) {
            <button type="button"
                    class="aspect-ratio-btn"
                    [class.selected]="isAspectRatioSelected(option.value)"
                    (click)="selectAspectRatio(option.value)">
              {{ option.label }}
            </button>
          }
        </div>
      </div>

      <!-- Credit Cost Notice -->
      <div class="credit-notice">
        <mat-icon>toll</mat-icon>
        <span>This will use <strong>{{ creditCost }} credits</strong></span>
      </div>
    </div>
  }
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancel()" [disabled]="isProcessing()">Cancel</button>
  <button mat-raised-button
          color="primary"
          [disabled]="!canCreate()"
          (click)="createBackgroundEdit()">
    @if (isProcessing()) {
      <mat-icon class="spinning">sync</mat-icon> Creating...
    } @else {
      <mat-icon>auto_fix_high</mat-icon> Create
    }
  </button>
</mat-dialog-actions>
