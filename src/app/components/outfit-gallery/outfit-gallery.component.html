<section class="section-card outfit-gallery">
  <header class="header">
    <h1>Generated outfits</h1>
    <div class="header-actions">
      <!-- Filter toggle -->
      <mat-button-toggle-group
        class="filter-toggle"
        [value]="activeFilter()"
        (change)="setFilter($event.value)"
        aria-label="Filter outfits"
      >
        <mat-button-toggle value="all">All</mat-button-toggle>
        <mat-button-toggle value="with-videos">
          <mat-icon>videocam</mat-icon>
          Videos
        </mat-button-toggle>
      </mat-button-toggle-group>
      <!-- Back to Studio button - always visible -->
      <button
        mat-stroked-button
        class="back-to-studio-btn"
        (click)="goToStudio()"
        matTooltip="Return to Studio"
      >
        <mat-icon>arrow_back</mat-icon>
        Back to Studio
      </button>
      <button
        mat-icon-button
        class="archive-btn"
        (click)="openArchivePanel()"
        matTooltip="View archived items"
        aria-label="View archived items"
      >
        <mat-icon>inventory_2</mat-icon>
      </button>
    </div>
  </header>

  <!-- AI Disclaimer Banner -->
  <app-ai-disclaimer variant="banner" *ngIf="(generatedImages$ | async)?.length"></app-ai-disclaimer>

  <!-- Studio Return Banner - Shows during tutorial OR when processing images -->
  <div
    class="studio-return-banner"
    [class.tutorial-highlight]="isGalleryReturnStep()"
    *ngIf="isGalleryReturnStep() || hasProcessingImages()"
  >
    <!-- Tutorial message (only during tutorial) -->
    <div class="tutorial-return-content" *ngIf="isGalleryReturnStep()">
      <div class="tutorial-return-icon">
        <mat-icon>celebration</mat-icon>
      </div>
      <div class="tutorial-return-text">
        <h3>Great job! Your first outfit is being created</h3>
        <p>While you wait, let's explore all the features in the Studio</p>
      </div>
    </div>
    <!-- Normal message (when not in tutorial but processing) -->
    <div class="studio-return-content" *ngIf="!isGalleryReturnStep() && hasProcessingImages()">
      <mat-icon>schedule</mat-icon>
      <span>Generation can take up to a minute. Create another outfit while you wait!</span>
    </div>
    <!-- Studio button -->
    <button
      class="studio-btn"
      [class.tutorial-studio-btn]="isGalleryReturnStep()"
      (click)="goToStudio()"
    >
      <mat-icon>brush</mat-icon>
      <span>{{ isGalleryReturnStep() ? 'Back to Studio' : 'Go to Studio' }}</span>
    </button>
  </div>

  <!-- Empty state (no outfits yet) - Enhanced (#13) -->
  <div class="empty" *ngIf="(generatedImages$ | async)?.length === 0">
    <mat-icon>auto_awesome</mat-icon>
    <h3>No outfits yet</h3>
    <p>Start by selecting a model and garments, then generate your first virtual try-on!</p>
    <button mat-raised-button color="primary" (click)="goToStudio()">
      <mat-icon>brush</mat-icon>
      Go to Studio
    </button>
  </div>

  <!-- Empty filter state -->
  <div class="empty" *ngIf="(generatedImages$ | async)?.length! > 0 && (filteredImages$ | async)?.length === 0">
    <mat-icon>videocam_off</mat-icon>
    <h3>No outfits with videos</h3>
    <p>None of your outfits have videos yet. Open an outfit and create a video!</p>
    <button mat-stroked-button (click)="setFilter('all')">
      <mat-icon>filter_alt_off</mat-icon>
      Show all outfits
    </button>
  </div>

  <!-- Gallery grid -->
  <div class="grid" *ngIf="(filteredImages$ | async) as images">
    <mat-card
      class="gallery-item"
      [class.clickable]="image.status === 'ready'"
      appearance="outlined"
      *ngFor="let image of images; index as i; trackBy: trackById"
    >
      <figure (click)="viewImage(image, i)" tabindex="0" role="button" aria-label="View generated outfit">
        <img *ngIf="image.status === 'ready'" [src]="image.imageUrl" alt="Generated outfit" />

        <!-- Processing state with progress indicator (#21) -->
        <div *ngIf="image.status === 'processing' || image.status === 'pending_retry'" class="processing-placeholder">
          <div class="processing-spinner">
            <mat-spinner diameter="48"></mat-spinner>
          </div>
          <span class="processing-stage">{{ image.status === 'pending_retry' ? 'Queued...' : 'Generating...' }}</span>
          <span class="processing-hint">This may take up to a minute</span>
        </div>

        <div *ngIf="image.status === 'failed'" class="failed-placeholder">
          <mat-icon>error_outline</mat-icon>
          <span class="failed-title">Generation failed</span>
          <span class="failed-reason" *ngIf="image.failureReason">{{ image.failureReason }}</span>
        </div>

        <!-- Click to view overlay (#23) -->
        <div class="hover-overlay" *ngIf="image.status === 'ready'">
          <mat-icon>visibility</mat-icon>
          <span>Click to view</span>
        </div>

        <!-- Tap for details hint - always visible on ready images -->
        <div class="tap-hint" *ngIf="image.status === 'ready'">
          <mat-icon>touch_app</mat-icon>
          <span>Tap to view & download</span>
        </div>

        <!-- Video badge -->
        <span class="video-badge" *ngIf="image.videoCount && image.videoCount > 0">
          <mat-icon>videocam</mat-icon>
        </span>

        <!-- Variants badge -->
        <span class="variants-badge" *ngIf="image.variantCount && image.variantCount > 1">
          <mat-icon>layers</mat-icon>
          {{ image.variantCount }}
        </span>
      </figure>

      <mat-card-content>
        <div class="meta">
          <span>{{ image.createdAt | date: 'short' }}</span>
          <span
            class="status-badge"
            [class.status-badge--ready]="image.status === 'ready'"
            [class.status-badge--failed]="image.status === 'failed'"
            [class.status-badge--pending-retry]="image.status === 'pending_retry'"
            [matTooltip]="image.status === 'failed' ? image.failureReason : (image.status === 'pending_retry' ? 'Server busy - will complete soon' : '')"
          >
            <mat-icon>{{
              image.status === 'ready' ? 'check_circle' :
              (image.status === 'failed' ? 'error' :
              (image.status === 'pending_retry' ? 'schedule' : 'timelapse'))
            }}</mat-icon>
            {{
              image.status === 'ready' ? 'Ready' :
              (image.status === 'failed' ? 'Failed' :
              (image.status === 'pending_retry' ? 'Queued' : 'Processing'))
            }}
          </span>
          <button
            mat-icon-button
            class="archive-outfit-btn"
            (click)="archive(image); $event.stopPropagation()"
            aria-label="Archive outfit"
            matTooltip="Move to archive"
          >
            <mat-icon>inventory_2</mat-icon>
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Create another outfit card - always visible at the end -->
    <div class="create-outfit-card" (click)="goToStudio()" tabindex="0" role="button" aria-label="Create another outfit">
      <div class="create-outfit-content">
        <div class="create-outfit-icon">
          <mat-icon>add</mat-icon>
        </div>
        <span class="create-outfit-text">Create another outfit</span>
      </div>
    </div>
  </div>
</section>

<!-- Archive Panel -->
<app-archive-panel
  [isOpen]="isArchivePanelOpen()"
  (closed)="closeArchivePanel()"
  (itemRestored)="onArchiveItemRestored()"
></app-archive-panel>
