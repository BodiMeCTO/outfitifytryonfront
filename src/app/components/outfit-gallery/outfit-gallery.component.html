<section class="section-card outfit-gallery">
  <header class="header">
    <h1>Generated outfits</h1>
    <button
      mat-icon-button
      class="archive-btn"
      (click)="openArchivePanel()"
      matTooltip="View archived items"
      aria-label="View archived items"
    >
      <mat-icon>inventory_2</mat-icon>
    </button>
  </header>

  <!-- Empty state (no outfits yet) -->
  <div class="empty" *ngIf="(generatedImages$ | async)?.length === 0">
    <mat-icon>hourglass_empty</mat-icon>
    <p>No generated outfits yet. Start by uploading a user image and choosing your garments.</p>
  </div>

  <!-- Gallery grid -->
  <div class="grid" *ngIf="(generatedImages$ | async) as images">
    <mat-card
      class="gallery-item"
      appearance="outlined"
      *ngFor="let image of images; index as i; trackBy: trackById"
    >
      <figure (click)="viewImage(image, i)" tabindex="0" role="button" aria-label="View generated outfit">
        <img *ngIf="image.status === 'ready'" [src]="image.imageUrl" alt="Generated outfit" />
        <img *ngIf="image.status === 'processing' || image.status === 'pending_retry'" src="/assets/images/outfit-loading.gif" alt="Creating outfit..." class="loading-gif" />
        <div *ngIf="image.status === 'failed'" class="failed-placeholder">
          <mat-icon>error_outline</mat-icon>
          <span class="failed-title">Generation failed</span>
          <span class="failed-reason" *ngIf="image.failureReason">{{ image.failureReason }}</span>
        </div>
        <!-- Variants badge -->
        <span class="variants-badge" *ngIf="image.variantCount && image.variantCount > 1">
          <mat-icon>layers</mat-icon>
          {{ image.variantCount }}
        </span>
      </figure>

      <mat-card-content>
        <div class="meta">
          <span>{{ image.createdAt | date: 'short' }}</span>
          <span
            class="status-badge"
            [class.status-badge--ready]="image.status === 'ready'"
            [class.status-badge--failed]="image.status === 'failed'"
            [class.status-badge--pending-retry]="image.status === 'pending_retry'"
            [matTooltip]="image.status === 'failed' ? image.failureReason : (image.status === 'pending_retry' ? 'Server busy - will complete soon' : '')"
          >
            <mat-icon>{{
              image.status === 'ready' ? 'check_circle' :
              (image.status === 'failed' ? 'error' :
              (image.status === 'pending_retry' ? 'schedule' : 'timelapse'))
            }}</mat-icon>
            {{
              image.status === 'ready' ? 'Ready' :
              (image.status === 'failed' ? 'Failed' :
              (image.status === 'pending_retry' ? 'Queued' : 'Processing'))
            }}
          </span>
          <button
            mat-icon-button
            (click)="archive(image); $event.stopPropagation()"
            aria-label="Archive outfit"
            matTooltip="Archive"
          >
            <mat-icon>archive</mat-icon>
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</section>

<!-- Archive Panel -->
<app-archive-panel
  [isOpen]="isArchivePanelOpen()"
  (closed)="closeArchivePanel()"
  (itemRestored)="onArchiveItemRestored()"
></app-archive-panel>
