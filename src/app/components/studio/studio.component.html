<div class="studio-container">
  <!-- Preview Panel (sticky on desktop) -->
  <aside class="preview-panel">
    <div class="preview-content">
      <!-- Model preview - only show if model has valid URL -->
      @if (selectedModel$ | async; as model) {
        @if (model.previewUrl || model.remoteUrl) {
          <div class="preview-image-wrapper">
            <img
              [src]="model.previewUrl || model.remoteUrl"
              alt="Selected model"
              class="preview-image"
            />
            <!-- Model count badge -->
            <span class="model-count-badge" *ngIf="(selectedModelCount$ | async)! > 1">
              +{{ (selectedModelCount$ | async)! - 1 }} more
            </span>
          </div>
        } @else {
          <div class="preview-placeholder">
            <mat-icon>person_outline</mat-icon>
            <p>Select a model to preview</p>
          </div>
        }
      } @else {
        <div class="preview-placeholder">
          <mat-icon>person_outline</mat-icon>
          <p>Select a model to preview</p>
        </div>
      }

      <!-- Selection Details Panel -->
      <div class="selection-details">
        <!-- Selected Models Section -->
        <div class="selection-section" *ngIf="selectedModels$ | async as models">
          <div class="selection-section-header">
            <span class="section-title-small">
              <mat-icon>person</mat-icon>
              Models ({{ models.length }}/{{ maxSelectedModels }})
            </span>
            <button
              class="clear-btn-inline"
              *ngIf="models.length > 0"
              (click)="clearModelSelection()"
              matTooltip="Clear models"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <div class="selection-thumbnails" *ngIf="models.length > 0">
            <div
              class="selection-thumb"
              *ngFor="let model of models; let i = index"
              [matTooltip]="model.name || 'Model ' + (i + 1)"
            >
              <img [src]="model.previewUrl || model.remoteUrl" [alt]="model.name || 'Model'" />
              <span class="thumb-badge">{{ i + 1 }}</span>
            </div>
          </div>
          <div class="empty-selection" *ngIf="models.length === 0">
            <span>No models selected</span>
          </div>
        </div>

        <!-- Selected Garments Section -->
        <div class="selection-section">
          <div class="selection-section-header">
            <span class="section-title-small">
              <mat-icon>checkroom</mat-icon>
              Garments ({{ selectedGarmentCount$ | async }})
            </span>
            <button
              class="clear-btn-inline"
              *ngIf="(selectedGarmentCount$ | async)! > 0"
              (click)="clearAllGarments()"
              matTooltip="Clear garments"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <ng-container *ngIf="selectedGarments$ | async as garments">
            <!-- Tops -->
            <div class="garment-row" *ngIf="garments.top.length > 0">
              <span class="garment-category-label">Tops</span>
              <div class="selection-thumbnails compact">
                <div class="selection-thumb small" *ngFor="let g of garments.top" [matTooltip]="g.name">
                  <img [src]="g.image" [alt]="g.name" />
                </div>
              </div>
            </div>

            <!-- Bottoms -->
            <div class="garment-row" *ngIf="garments.bottom.length > 0">
              <span class="garment-category-label">Bottoms</span>
              <div class="selection-thumbnails compact">
                <div class="selection-thumb small" *ngFor="let g of garments.bottom" [matTooltip]="g.name">
                  <img [src]="g.image" [alt]="g.name" />
                </div>
              </div>
            </div>

            <!-- Full Body -->
            <div class="garment-row" *ngIf="garments.fullBody.length > 0">
              <span class="garment-category-label">Full Body</span>
              <div class="selection-thumbnails compact">
                <div class="selection-thumb small" *ngFor="let g of garments.fullBody" [matTooltip]="g.name">
                  <img [src]="g.image" [alt]="g.name" />
                </div>
              </div>
            </div>

            <!-- Jackets -->
            <div class="garment-row" *ngIf="garments.jacket.length > 0">
              <span class="garment-category-label">Jackets</span>
              <div class="selection-thumbnails compact">
                <div class="selection-thumb small" *ngFor="let g of garments.jacket" [matTooltip]="g.name">
                  <img [src]="g.image" [alt]="g.name" />
                </div>
              </div>
            </div>

            <!-- Footwear -->
            <div class="garment-row" *ngIf="garments.footwear.length > 0">
              <span class="garment-category-label">Footwear</span>
              <div class="selection-thumbnails compact">
                <div class="selection-thumb small" *ngFor="let g of garments.footwear" [matTooltip]="g.name">
                  <img [src]="g.image" [alt]="g.name" />
                </div>
              </div>
            </div>

            <!-- Accessories -->
            <div class="garment-row" *ngIf="garments.accessories.length > 0">
              <span class="garment-category-label">Accessories</span>
              <div class="selection-thumbnails compact">
                <div class="selection-thumb small" *ngFor="let g of garments.accessories" [matTooltip]="g.name">
                  <img [src]="g.image" [alt]="g.name" />
                </div>
              </div>
            </div>

            <!-- Empty state -->
            <div class="empty-selection" *ngIf="(selectedGarmentCount$ | async) === 0">
              <span>No garments selected</span>
            </div>
          </ng-container>
        </div>

        <!-- Options Summary (Pose, Background, Ratio) -->
        <div class="selection-section options-summary" *ngIf="selectedPoseId() !== 'original' || hasBackgroundSelection() || selectedAspectRatio() !== 'original'">
          <div class="option-item" *ngIf="selectedPoseId() !== 'original'">
            <mat-icon>accessibility_new</mat-icon>
            <span>{{ selectedPoseId() }}</span>
          </div>
          <div class="option-item" *ngIf="hasBackgroundSelection()">
            <mat-icon>wallpaper</mat-icon>
            <span>{{ selectedPresetInfo?.name || 'Custom' }}</span>
          </div>
          <div class="option-item" *ngIf="selectedAspectRatio() !== 'original'">
            <mat-icon>aspect_ratio</mat-icon>
            <span>{{ selectedAspectRatio() }}</span>
          </div>
        </div>
      </div>

      <!-- Credit cost indicator -->
      <div class="credit-cost" *ngIf="(selectedGarmentCount$ | async)! > 0 && (selectedModelCount$ | async)! > 0">
        <mat-icon>toll</mat-icon>
        <span>
          {{ generationCreditCost }} credits
          <span class="credit-breakdown" *ngIf="(selectedModelCount$ | async)! > 1">
            ({{ generationCreditCost / (selectedModelCount$ | async)! }} x {{ selectedModelCount$ | async }})
          </span>
        </span>
      </div>

      <!-- Generate button (desktop) -->
      <div
        class="generate-button-wrapper desktop-only"
        [matTooltip]="(canGenerate$ | async) ? '' : 'Select a model and at least one garment to generate'"
        matTooltipPosition="above"
      >
        <app-luxe-button
          class="generate-button"
          variant="primary"
          size="lg"
          [fullWidth]="true"
          [loading]="isGenerating()"
          [disabled]="!(canGenerate$ | async)"
          (clicked)="generateOutfit()"
        >
          <mat-icon>auto_awesome</mat-icon>
          {{ isGenerating() ? 'Generating...' : 'Generate Outfit' }}
        </app-luxe-button>
      </div>
    </div>
  </aside>

  <!-- Generation Progress Overlay -->
  <app-generation-progress [isVisible]="isGenerating()"></app-generation-progress>

  <!-- Workflow Sections -->
  <main class="workflow-sections">
    <!-- Model Images Section -->
    <section class="workflow-section">
      <div class="section-header-row">
        <h2 class="section-label-gold">Model Images</h2>
        <div class="section-actions">
          <button
            class="template-toggle-btn"
            [class.active]="showTemplates()"
            (click)="toggleShowTemplates()"
            [matTooltip]="showTemplates() ? 'Hide preloaded templates' : 'Show preloaded templates'"
            aria-label="Toggle preloaded template visibility"
          >
            <mat-icon>{{ showTemplates() ? 'visibility' : 'visibility_off' }}</mat-icon>
            <span class="toggle-label">Templates</span>
          </button>
          <button
            class="archive-btn-small"
            (click)="openArchivePanel()"
            matTooltip="View archived items"
            aria-label="View archived model images"
          >
            <mat-icon>inventory_2</mat-icon>
          </button>
          <button
            class="upload-btn-small"
            (click)="modelUploadInput.click()"
            aria-label="Upload model image"
            matTooltip="Upload model image"
          >
            <mat-icon>add_photo_alternate</mat-icon>
            <mat-spinner *ngIf="isUploadingModel()" [diameter]="16"></mat-spinner>
          </button>
        </div>
        <input
          #modelUploadInput
          type="file"
          accept="image/*"
          multiple
          (change)="handleModelUpload($event)"
          hidden
        />
      </div>

      <ng-container *ngIf="originalModelImages$ | async as models">
        <!-- Mobile: Carousel view -->
        <app-luxe-carousel
          class="mobile-carousel"
          [showCount]="false"
          [itemCount]="models.length"
          gap="0.75rem"
        >
          <div class="model-card-wrapper carousel-item" *ngFor="let model of models">
            <app-luxe-image-card
              [src]="model.previewUrl || model.remoteUrl"
              [selected]="isModelSelected(model)"
              aspectRatio="3:4"
              (cardClick)="selectModel(model)"
            ></app-luxe-image-card>
            <!-- Selection badge showing order number -->
            <span class="selection-badge" *ngIf="getModelSelectionBadge(model) as badge">{{ badge }}</span>
            <button
              class="card-archive-btn"
              (click)="archiveModelImage($event, model)"
              matTooltip="Archive"
              *ngIf="model.id"
            >
              <mat-icon>archive</mat-icon>
            </button>
          </div>
          <!-- Upload card in carousel -->
          <div class="upload-card-wrapper carousel-item">
            <button class="upload-card" (click)="modelUploadInput.click()">
              <mat-icon>add_photo_alternate</mat-icon>
              <span>Add</span>
            </button>
          </div>
        </app-luxe-carousel>

        <!-- Desktop: Grid view -->
        <div class="model-grid desktop-grid">
          <div class="model-card-wrapper" *ngFor="let model of models">
            <app-luxe-image-card
              [src]="model.previewUrl || model.remoteUrl"
              [selected]="isModelSelected(model)"
              aspectRatio="3:4"
              (cardClick)="selectModel(model)"
            ></app-luxe-image-card>
            <!-- Selection badge showing order number -->
            <span class="selection-badge" *ngIf="getModelSelectionBadge(model) as badge">{{ badge }}</span>
            <button
              class="card-archive-btn"
              (click)="archiveModelImage($event, model)"
              matTooltip="Archive"
              *ngIf="model.id"
            >
              <mat-icon>archive</mat-icon>
            </button>
          </div>
          <button class="upload-card" (click)="modelUploadInput.click()">
            <mat-icon>add_photo_alternate</mat-icon>
            <span>Upload</span>
            <mat-spinner *ngIf="isUploadingModel()" [diameter]="24"></mat-spinner>
          </button>
        </div>

        <!-- Empty state -->
        <div class="empty-hint" *ngIf="models.length === 0">
          <mat-icon>person_outline</mat-icon>
          <p>Upload a model image to get started</p>
        </div>
      </ng-container>
    </section>

    <!-- Pose Section (Optional - pre-defined poses) -->
    <section class="workflow-section pose-section">
      <div class="section-header-row">
        <h2 class="section-label-gold">Pose <span class="optional-tag">(Optional)</span></h2>
      </div>

      <div class="pose-preset-grid">
        <button
          class="pose-tile"
          *ngFor="let pose of posePresets"
          [class.selected]="isPoseSelected(pose.id)"
          (click)="selectPose(pose.id)"
        >
          <span class="pose-name">{{ pose.name }}</span>
          <mat-icon class="pose-check" *ngIf="isPoseSelected(pose.id)">check_circle</mat-icon>
        </button>
      </div>
    </section>

    <!-- Background Section (Optional - AI-generated or uploaded) -->
    <section class="workflow-section background-section">
      <div class="section-header-row">
        <h2 class="section-label-gold">Background <span class="optional-tag">(Optional)</span></h2>
      </div>

      <!-- Selected Background Indicator -->
      <div class="selected-background-indicator" *ngIf="selectedPresetInfo">
        <div class="indicator-content">
          <mat-icon>wallpaper</mat-icon>
          <div class="indicator-text">
            <span class="indicator-name">{{ selectedPresetInfo.name }}</span>
            <span class="indicator-category">{{ selectedPresetInfo.category }}</span>
          </div>
        </div>
        <button class="indicator-clear" (click)="clearBackgroundSelection()" matTooltip="Clear selection">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <!-- Category Cards Grid -->
      <div class="background-category-grid">
        <button
          *ngFor="let cat of backgroundCategories"
          class="category-card"
          [class.expanded]="isCategoryExpanded(cat.id)"
          [class.has-selection]="activeBackgroundCategory() === cat.id && hasBackgroundSelection()"
          (click)="selectBackgroundCategory(cat.id)"
        >
          <span class="category-name">{{ cat.label }}</span>
          <span class="category-desc">{{ cat.description }}</span>
          <mat-icon class="category-expand-icon">{{ isCategoryExpanded(cat.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
      </div>

      <!-- Expanded Category Content -->
      <div class="category-expanded-content" #backgroundExpandedContent *ngIf="expandedCategory() && expandedCategory() !== 'original'">
        <!-- Preset Grid -->
        <div class="background-preset-grid">
          <button
            class="preset-tile"
            *ngFor="let preset of filteredPresets"
            [class.selected]="isPresetSelected(preset.id)"
            (click)="selectPreset(preset)"
          >
            <span class="preset-name">{{ preset.name }}</span>
            <mat-icon class="preset-check" *ngIf="isPresetSelected(preset.id)">check_circle</mat-icon>
          </button>
        </div>

        <!-- Custom Prompt -->
        <div class="custom-prompt-section">
          <label class="prompt-label">Or describe a custom background</label>
          <textarea
            class="custom-prompt-input"
            [value]="customBackgroundPrompt()"
            (input)="onCustomPromptChange($any($event.target).value)"
            placeholder="e.g., modern minimalist living room with large windows and natural light"
            rows="2"
          ></textarea>
        </div>
      </div>

      <!-- Original Category Expanded (empty state) -->
      <div class="category-expanded-content original-expanded" *ngIf="expandedCategory() === 'original'">
        <div class="original-empty-state">
          <mat-icon>photo_camera</mat-icon>
          <p>The original background from your model image will be preserved</p>
        </div>
      </div>
    </section>

    <!-- Aspect Ratio Section -->
    <section class="workflow-section aspect-ratio-section">
      <div class="section-header-row">
        <h2 class="section-label-gold">Aspect Ratio</h2>
      </div>

      <div class="aspect-ratio-options">
        <button
          class="aspect-ratio-btn"
          *ngFor="let option of aspectRatioOptions"
          [class.selected]="selectedAspectRatio() === option.value"
          (click)="selectAspectRatio(option.value)"
        >
          {{ option.label }}
        </button>
      </div>
    </section>

    <!-- Garments Section -->
    <section class="workflow-section">
      <div class="section-header-row">
        <h2 class="section-label-gold">Garments</h2>
        <div class="section-actions">
          <button
            class="clear-btn-small"
            *ngIf="(selectedGarmentCount$ | async)! > 0"
            (click)="clearAllGarments()"
            matTooltip="Clear all selected garments"
            aria-label="Clear all garments"
          >
            <mat-icon>clear_all</mat-icon>
            <span class="clear-label">Clear</span>
          </button>
          <button
            class="archive-btn-small"
            (click)="openArchivePanel()"
            matTooltip="View archived items"
            aria-label="View archived garments"
          >
            <mat-icon>inventory_2</mat-icon>
          </button>
          <app-luxe-button
            variant="secondary"
            size="sm"
            icon="add_photo_alternate"
            (clicked)="openGarmentUploadDialog()"
          >
            Add Garment
          </app-luxe-button>
        </div>
      </div>

      <!-- Garment Carousels by Category -->
      <ng-container *ngIf="garmentsByGroup$ | async as groups">
        <ng-container *ngIf="selectedGarments$ | async as selected">
          <div *ngFor="let group of garmentGroups" class="garment-category">
            <ng-container *ngIf="groups[group.key]?.length">
              <!-- Category header with clear button -->
              <div class="category-header-row">
                <h3 class="category-label">{{ group.label }}</h3>
                <span class="category-count">{{ groups[group.key].length }} items</span>
                <button
                  class="category-clear-btn"
                  *ngIf="(group.key === 'tops' && selected.top.length > 0) ||
                         (group.key === 'bottoms' && selected.bottom.length > 0) ||
                         (group.key === 'full-body' && selected.fullBody.length > 0) ||
                         (group.key === 'jackets' && selected.jacket.length > 0) ||
                         (group.key === 'footwear' && selected.footwear.length > 0) ||
                         (group.key === 'accessories' && selected.accessories.length > 0)"
                  (click)="clearGarmentCategory($event, group.key)"
                  matTooltip="Clear {{ group.label | lowercase }}"
                  [attr.aria-label]="'Clear ' + group.label"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
              <app-luxe-carousel
                [showCount]="false"
                [itemCount]="groups[group.key].length"
                gap="1rem"
              >
                <div class="garment-card-wrapper" *ngFor="let garment of groups[group.key]">
                  <app-luxe-image-card
                    class="garment-card"
                    [src]="garment.image"
                    [selected]="isGarmentSelected(garment)"
                    aspectRatio="3:4"
                    (cardClick)="toggleGarment(garment)"
                  ></app-luxe-image-card>
                  <button
                    class="card-archive-btn"
                    (click)="archiveGarment($event, garment)"
                    matTooltip="Archive"
                  >
                    <mat-icon>archive</mat-icon>
                  </button>
                </div>
              </app-luxe-carousel>
            </ng-container>
          </div>
        </ng-container>
      </ng-container>

      <!-- Empty state when no garments -->
      <div class="empty-garments" *ngIf="(garments$ | async)?.length === 0">
        <mat-icon>checkroom</mat-icon>
        <p>No garments yet. Add your first garment to get started!</p>
        <app-luxe-button
          variant="primary"
          icon="add_photo_alternate"
          (clicked)="openGarmentUploadDialog()"
        >
          Add Garment
        </app-luxe-button>
      </div>
    </section>

  </main>

  <!-- Mobile Footer with selection summary and generate button -->
  <div class="mobile-footer">
    <!-- Selection summary (icons only) -->
    <div class="mobile-selection-summary">
      <span class="summary-icon" [class.is-checked]="selectedModel$ | async" matTooltip="Model">
        <mat-icon>person</mat-icon>
        <mat-icon class="status-icon">{{ (selectedModel$ | async) ? 'check' : 'close' }}</mat-icon>
      </span>
      <span class="summary-icon optional" [class.is-checked]="selectedPoseId() !== 'original'" matTooltip="Pose (optional)">
        <mat-icon>accessibility_new</mat-icon>
        <mat-icon class="status-icon" *ngIf="selectedPoseId() !== 'original'">check</mat-icon>
      </span>
      <span class="summary-icon optional" [class.is-checked]="hasBackgroundSelection()" matTooltip="Background (optional)">
        <mat-icon>wallpaper</mat-icon>
        <mat-icon class="status-icon" *ngIf="hasBackgroundSelection()">check</mat-icon>
      </span>
      <span class="summary-icon" [class.is-checked]="(selectedGarmentCount$ | async)! > 0" matTooltip="Garments">
        <mat-icon>checkroom</mat-icon>
        <mat-icon class="status-icon">{{ (selectedGarmentCount$ | async)! > 0 ? 'check' : 'close' }}</mat-icon>
      </span>
      <span class="credit-cost-mobile" *ngIf="(selectedGarmentCount$ | async)! > 0">
        <mat-icon>toll</mat-icon>
        {{ generationCreditCost }}
      </span>
    </div>

    <!-- Generate button -->
    <div
      class="generate-button-wrapper"
      [matTooltip]="(canGenerate$ | async) ? '' : 'Select a model and at least one garment'"
      matTooltipPosition="above"
    >
      <app-luxe-button
        variant="primary"
        size="lg"
        [fullWidth]="true"
        [loading]="isGenerating()"
        [disabled]="!(canGenerate$ | async)"
        (clicked)="generateOutfit()"
      >
        {{ isGenerating() ? 'Generating...' : 'Generate Outfit' }}
      </app-luxe-button>
    </div>
  </div>
</div>

<!-- Archive Panel -->
<app-archive-panel
  [isOpen]="isArchivePanelOpen()"
  (closed)="closeArchivePanel()"
  (itemRestored)="onArchiveItemRestored()"
></app-archive-panel>
