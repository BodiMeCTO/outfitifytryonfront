<div class="studio-container">
  <!-- Preview Panel (sticky on desktop) -->
  <aside class="preview-panel">
    <div class="preview-content">
      <!-- Model preview -->
      <div class="preview-image-wrapper" *ngIf="selectedModel$ | async as model; else noModelPreview">
        <img
          [src]="model.previewUrl || model.remoteUrl"
          alt="Selected model"
          class="preview-image"
        />
      </div>
      <ng-template #noModelPreview>
        <div class="preview-placeholder">
          <mat-icon>person_outline</mat-icon>
          <p>Select a model to preview</p>
        </div>
      </ng-template>

      <!-- Selected items summary -->
      <div class="selection-summary">
        <div class="summary-item" *ngIf="selectedModel$ | async">
          <mat-icon>check_circle</mat-icon>
          <span>Model selected</span>
        </div>
        <div class="summary-item" *ngIf="selectedPoseId() !== 'original'">
          <mat-icon>check_circle</mat-icon>
          <span>Pose: {{ selectedPoseId() }}</span>
        </div>
        <div class="summary-item" *ngIf="hasBackgroundSelection()">
          <mat-icon>check_circle</mat-icon>
          <span>Background selected</span>
        </div>
        <div class="summary-item" *ngIf="selectedAspectRatio() !== 'original'">
          <mat-icon>check_circle</mat-icon>
          <span>{{ selectedAspectRatio() }} ratio</span>
        </div>
        <div class="summary-item" *ngIf="(selectedGarmentCount$ | async) as count">
          <mat-icon>check_circle</mat-icon>
          <span>{{ count }} garment{{ count > 1 ? 's' : '' }} selected</span>
        </div>
      </div>

      <!-- Credit cost indicator -->
      <div class="credit-cost" *ngIf="(selectedGarmentCount$ | async)! > 0">
        <mat-icon>toll</mat-icon>
        <span>{{ generationCreditCost }} credits</span>
      </div>

      <!-- Generate button (desktop) -->
      <div
        class="generate-button-wrapper desktop-only"
        [matTooltip]="(canGenerate$ | async) ? '' : 'Select a model and at least one garment to generate'"
        matTooltipPosition="above"
      >
        <app-luxe-button
          class="generate-button"
          variant="primary"
          size="lg"
          [fullWidth]="true"
          [loading]="isGenerating()"
          [disabled]="!(canGenerate$ | async)"
          (clicked)="generateOutfit()"
        >
          <mat-icon>auto_awesome</mat-icon>
          {{ isGenerating() ? 'Generating...' : 'Generate Outfit' }}
        </app-luxe-button>
      </div>
    </div>
  </aside>

  <!-- Generation Progress Overlay -->
  <app-generation-progress [isVisible]="isGenerating()"></app-generation-progress>

  <!-- Workflow Sections -->
  <main class="workflow-sections">
    <!-- Model Images Section -->
    <section class="workflow-section">
      <div class="section-header-row">
        <h2 class="section-label-gold">Model Images</h2>
        <div class="section-actions">
          <button
            class="template-toggle-btn"
            [class.active]="showTemplates()"
            (click)="toggleShowTemplates()"
            [matTooltip]="showTemplates() ? 'Hide preloaded templates' : 'Show preloaded templates'"
            aria-label="Toggle preloaded template visibility"
          >
            <mat-icon>{{ showTemplates() ? 'visibility' : 'visibility_off' }}</mat-icon>
            <span class="toggle-label">Templates</span>
          </button>
          <button
            class="archive-btn-small"
            (click)="openArchivePanel()"
            matTooltip="View archived items"
            aria-label="View archived model images"
          >
            <mat-icon>inventory_2</mat-icon>
          </button>
          <button
            class="upload-btn-small"
            (click)="modelUploadInput.click()"
            aria-label="Upload model image"
            matTooltip="Upload model image"
          >
            <mat-icon>add_photo_alternate</mat-icon>
            <mat-spinner *ngIf="isUploadingModel()" [diameter]="16"></mat-spinner>
          </button>
        </div>
        <input
          #modelUploadInput
          type="file"
          accept="image/*"
          multiple
          (change)="handleModelUpload($event)"
          hidden
        />
      </div>

      <ng-container *ngIf="originalModelImages$ | async as models">
        <!-- Mobile: Carousel view -->
        <app-luxe-carousel
          class="mobile-carousel"
          [showCount]="false"
          [itemCount]="models.length"
          gap="0.75rem"
        >
          <div class="model-card-wrapper carousel-item" *ngFor="let model of models">
            <app-luxe-image-card
              [src]="model.previewUrl || model.remoteUrl"
              [selected]="(selectedModel$ | async)?.id === model.id"
              aspectRatio="3:4"
              (cardClick)="selectModel(model)"
            ></app-luxe-image-card>
            <button
              class="card-archive-btn"
              (click)="archiveModelImage($event, model)"
              matTooltip="Archive"
              *ngIf="model.id"
            >
              <mat-icon>archive</mat-icon>
            </button>
          </div>
          <!-- Upload card in carousel -->
          <div class="upload-card-wrapper carousel-item">
            <button class="upload-card" (click)="modelUploadInput.click()">
              <mat-icon>add_photo_alternate</mat-icon>
              <span>Add</span>
            </button>
          </div>
        </app-luxe-carousel>

        <!-- Desktop: Grid view -->
        <div class="model-grid desktop-grid">
          <div class="model-card-wrapper" *ngFor="let model of models">
            <app-luxe-image-card
              [src]="model.previewUrl || model.remoteUrl"
              [selected]="(selectedModel$ | async)?.id === model.id"
              aspectRatio="3:4"
              (cardClick)="selectModel(model)"
            ></app-luxe-image-card>
            <button
              class="card-archive-btn"
              (click)="archiveModelImage($event, model)"
              matTooltip="Archive"
              *ngIf="model.id"
            >
              <mat-icon>archive</mat-icon>
            </button>
          </div>
          <button class="upload-card" (click)="modelUploadInput.click()">
            <mat-icon>add_photo_alternate</mat-icon>
            <span>Upload</span>
            <mat-spinner *ngIf="isUploadingModel()" [diameter]="24"></mat-spinner>
          </button>
        </div>

        <!-- Empty state -->
        <div class="empty-hint" *ngIf="models.length === 0">
          <mat-icon>person_outline</mat-icon>
          <p>Upload a model image to get started</p>
        </div>
      </ng-container>
    </section>

    <!-- Pose Section (Optional - pre-defined poses) -->
    <section class="workflow-section pose-section">
      <div class="section-header-row">
        <h2 class="section-label-gold">Pose <span class="optional-tag">(Optional)</span></h2>
      </div>

      <div class="pose-preset-grid">
        <button
          class="pose-tile"
          *ngFor="let pose of posePresets"
          [class.selected]="isPoseSelected(pose.id)"
          (click)="selectPose(pose.id)"
        >
          <span class="pose-name">{{ pose.name }}</span>
          <mat-icon class="pose-check" *ngIf="isPoseSelected(pose.id)">check_circle</mat-icon>
        </button>
      </div>
    </section>

    <!-- Background Section (Optional - AI-generated or uploaded) -->
    <section class="workflow-section background-section">
      <div class="section-header-row">
        <h2 class="section-label-gold">Background <span class="optional-tag">(Optional)</span></h2>
      </div>

      <!-- Selected Background Indicator -->
      <div class="selected-background-indicator" *ngIf="selectedPresetInfo">
        <div class="indicator-content">
          <mat-icon>wallpaper</mat-icon>
          <div class="indicator-text">
            <span class="indicator-name">{{ selectedPresetInfo.name }}</span>
            <span class="indicator-category">{{ selectedPresetInfo.category }}</span>
          </div>
        </div>
        <button class="indicator-clear" (click)="clearBackgroundSelection()" matTooltip="Clear selection">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <!-- Category Cards Grid -->
      <div class="background-category-grid">
        <button
          *ngFor="let cat of backgroundCategories"
          class="category-card"
          [class.expanded]="isCategoryExpanded(cat.id)"
          [class.has-selection]="activeBackgroundCategory() === cat.id && hasBackgroundSelection()"
          (click)="selectBackgroundCategory(cat.id)"
        >
          <span class="category-name">{{ cat.label }}</span>
          <span class="category-desc">{{ cat.description }}</span>
          <mat-icon class="category-expand-icon">{{ isCategoryExpanded(cat.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
      </div>

      <!-- Expanded Category Content -->
      <div class="category-expanded-content" *ngIf="expandedCategory() && expandedCategory() !== 'original'">
        <!-- Preset Grid -->
        <div class="background-preset-grid">
          <button
            class="preset-tile"
            *ngFor="let preset of filteredPresets"
            [class.selected]="isPresetSelected(preset.id)"
            (click)="selectPreset(preset)"
          >
            <span class="preset-name">{{ preset.name }}</span>
            <mat-icon class="preset-check" *ngIf="isPresetSelected(preset.id)">check_circle</mat-icon>
          </button>
        </div>

        <!-- Custom Prompt -->
        <div class="custom-prompt-section">
          <label class="prompt-label">Or describe a custom background</label>
          <textarea
            class="custom-prompt-input"
            [value]="customBackgroundPrompt()"
            (input)="onCustomPromptChange($any($event.target).value)"
            placeholder="e.g., modern minimalist living room with large windows and natural light"
            rows="2"
          ></textarea>
        </div>
      </div>

      <!-- Original Category Expanded (empty state) -->
      <div class="category-expanded-content original-expanded" *ngIf="expandedCategory() === 'original'">
        <div class="original-empty-state">
          <mat-icon>photo_camera</mat-icon>
          <p>The original background from your model image will be preserved</p>
        </div>
      </div>
    </section>

    <!-- Aspect Ratio Section -->
    <section class="workflow-section aspect-ratio-section">
      <div class="section-header-row">
        <h2 class="section-label-gold">Aspect Ratio</h2>
      </div>

      <div class="aspect-ratio-options">
        <button
          class="aspect-ratio-btn"
          *ngFor="let option of aspectRatioOptions"
          [class.selected]="selectedAspectRatio() === option.value"
          (click)="selectAspectRatio(option.value)"
        >
          {{ option.label }}
        </button>
      </div>
    </section>

    <!-- Garments Section -->
    <section class="workflow-section">
      <div class="section-header-row">
        <h2 class="section-label-gold">Garments</h2>
        <div class="section-actions">
          <button
            class="archive-btn-small"
            (click)="openArchivePanel()"
            matTooltip="View archived items"
            aria-label="View archived garments"
          >
            <mat-icon>inventory_2</mat-icon>
          </button>
          <app-luxe-button
            variant="secondary"
            size="sm"
            icon="add_photo_alternate"
            (clicked)="openGarmentUploadDialog()"
          >
            Add Garment
          </app-luxe-button>
        </div>
      </div>

      <!-- Garment Carousels by Category -->
      <ng-container *ngIf="garmentsByGroup$ | async as groups">
        <div *ngFor="let group of garmentGroups" class="garment-category">
          <ng-container *ngIf="groups[group.key]?.length">
            <app-luxe-carousel
              [label]="group.label"
              [showCount]="true"
              [itemCount]="groups[group.key].length"
              gap="1rem"
            >
              <div class="garment-card-wrapper" *ngFor="let garment of groups[group.key]">
                <app-luxe-image-card
                  class="garment-card"
                  [src]="garment.image"
                  [selected]="isGarmentSelected(garment)"
                  aspectRatio="3:4"
                  (cardClick)="toggleGarment(garment)"
                ></app-luxe-image-card>
                <button
                  class="card-archive-btn"
                  (click)="archiveGarment($event, garment)"
                  matTooltip="Archive"
                >
                  <mat-icon>archive</mat-icon>
                </button>
              </div>
            </app-luxe-carousel>
          </ng-container>
        </div>
      </ng-container>

      <!-- Empty state when no garments -->
      <div class="empty-garments" *ngIf="(garments$ | async)?.length === 0">
        <mat-icon>checkroom</mat-icon>
        <p>No garments yet. Add your first garment to get started!</p>
        <app-luxe-button
          variant="primary"
          icon="add_photo_alternate"
          (clicked)="openGarmentUploadDialog()"
        >
          Add Garment
        </app-luxe-button>
      </div>
    </section>

  </main>

  <!-- Mobile Footer with selection summary and generate button -->
  <div class="mobile-footer">
    <!-- Selection summary (icons only) -->
    <div class="mobile-selection-summary">
      <span class="summary-icon" [class.is-checked]="selectedModel$ | async" matTooltip="Model">
        <mat-icon>person</mat-icon>
        <mat-icon class="status-icon">{{ (selectedModel$ | async) ? 'check' : 'close' }}</mat-icon>
      </span>
      <span class="summary-icon optional" [class.is-checked]="selectedPoseId() !== 'original'" matTooltip="Pose (optional)">
        <mat-icon>accessibility_new</mat-icon>
        <mat-icon class="status-icon" *ngIf="selectedPoseId() !== 'original'">check</mat-icon>
      </span>
      <span class="summary-icon optional" [class.is-checked]="hasBackgroundSelection()" matTooltip="Background (optional)">
        <mat-icon>wallpaper</mat-icon>
        <mat-icon class="status-icon" *ngIf="hasBackgroundSelection()">check</mat-icon>
      </span>
      <span class="summary-icon" [class.is-checked]="(selectedGarmentCount$ | async)! > 0" matTooltip="Garments">
        <mat-icon>checkroom</mat-icon>
        <mat-icon class="status-icon">{{ (selectedGarmentCount$ | async)! > 0 ? 'check' : 'close' }}</mat-icon>
      </span>
      <span class="credit-cost-mobile" *ngIf="(selectedGarmentCount$ | async)! > 0">
        <mat-icon>toll</mat-icon>
        {{ generationCreditCost }}
      </span>
    </div>

    <!-- Generate button -->
    <div
      class="generate-button-wrapper"
      [matTooltip]="(canGenerate$ | async) ? '' : 'Select a model and at least one garment'"
      matTooltipPosition="above"
    >
      <app-luxe-button
        variant="primary"
        size="lg"
        [fullWidth]="true"
        [loading]="isGenerating()"
        [disabled]="!(canGenerate$ | async)"
        (clicked)="generateOutfit()"
      >
        {{ isGenerating() ? 'Generating...' : 'Generate Outfit' }}
      </app-luxe-button>
    </div>
  </div>
</div>

<!-- Archive Panel -->
<app-archive-panel
  [isOpen]="isArchivePanelOpen()"
  (closed)="closeArchivePanel()"
  (itemRestored)="onArchiveItemRestored()"
></app-archive-panel>
