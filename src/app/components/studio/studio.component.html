<div class="studio-container">
  <!-- Preview Panel (sticky on desktop) -->
  <aside class="preview-panel" #previewPanel>
    <div class="preview-content">
      <!-- Outfit Preview Header -->
      <div class="outfit-preview-header">
        <div class="outfit-title-group">
          <div class="outfit-title">
            <mat-icon>auto_awesome</mat-icon>
            <h2>Your Outfit</h2>
          </div>
          <span class="outfit-subtitle">This is what will be generated</span>
        </div>
        <button
          class="gallery-link-btn"
          (click)="goToGallery()"
          matTooltip="View generated outfits"
        >
          <mat-icon>collections</mat-icon>
          <span>Gallery</span>
        </button>
      </div>

      <!-- Selection Details Panel -->
      <div class="selection-details">
        <!-- Selected Models Section -->
        <div class="selection-section" *ngIf="selectedModels$ | async as models">
          <div class="selection-section-header">
            <span class="section-title-small">
              <mat-icon>person</mat-icon>
              Model{{ models.length !== 1 ? 's' : '' }}
            </span>
            <button
              class="clear-btn-inline"
              *ngIf="models.length > 0"
              (click)="clearModelSelection()"
              matTooltip="Clear all"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <div class="selection-thumbnails large" *ngIf="models.length > 0">
            <div
              class="selection-thumb large clickable"
              *ngFor="let model of models; let i = index"
              [matTooltip]="'Click to remove'"
              (click)="selectModel(model)"
            >
              <img [src]="model.previewUrl || model.remoteUrl" [alt]="model.name || 'Model'" />
              <span class="thumb-badge">{{ i + 1 }}</span>
              <div class="remove-indicator">
                <mat-icon>close</mat-icon>
              </div>
            </div>
          </div>
          <div class="empty-selection" *ngIf="models.length === 0">
            <mat-icon>person_add</mat-icon>
            <span>Select a model</span>
          </div>
        </div>

        <!-- Selected Garments Section -->
        <div class="selection-section">
          <div class="selection-section-header">
            <span class="section-title-small">
              <mat-icon>checkroom</mat-icon>
              Garments
            </span>
            <button
              class="clear-btn-inline"
              *ngIf="(selectedGarmentCount$ | async)! > 0"
              (click)="clearAllGarments()"
              matTooltip="Clear all"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <ng-container *ngIf="selectedGarments$ | async as garments">
            <div class="garments-grid" *ngIf="(selectedGarmentCount$ | async)! > 0">
              <!-- All garments in a unified grid -->
              <ng-container *ngFor="let g of garments.top">
                <div
                  class="selection-thumb large clickable"
                  [matTooltip]="g.name + ' - Click to remove'"
                  (click)="toggleGarment(g)"
                >
                  <img [src]="g.image" [alt]="g.name" />
                  <span class="garment-type-badge">Top</span>
                  <div class="remove-indicator">
                    <mat-icon>close</mat-icon>
                  </div>
                </div>
              </ng-container>
              <ng-container *ngFor="let g of garments.bottom">
                <div
                  class="selection-thumb large clickable"
                  [matTooltip]="g.name + ' - Click to remove'"
                  (click)="toggleGarment(g)"
                >
                  <img [src]="g.image" [alt]="g.name" />
                  <span class="garment-type-badge">Bottom</span>
                  <div class="remove-indicator">
                    <mat-icon>close</mat-icon>
                  </div>
                </div>
              </ng-container>
              <ng-container *ngFor="let g of garments.fullBody">
                <div
                  class="selection-thumb large clickable"
                  [matTooltip]="g.name + ' - Click to remove'"
                  (click)="toggleGarment(g)"
                >
                  <img [src]="g.image" [alt]="g.name" />
                  <span class="garment-type-badge">Full</span>
                  <div class="remove-indicator">
                    <mat-icon>close</mat-icon>
                  </div>
                </div>
              </ng-container>
              <ng-container *ngFor="let g of garments.jacket">
                <div
                  class="selection-thumb large clickable"
                  [matTooltip]="g.name + ' - Click to remove'"
                  (click)="toggleGarment(g)"
                >
                  <img [src]="g.image" [alt]="g.name" />
                  <span class="garment-type-badge">Jacket</span>
                  <div class="remove-indicator">
                    <mat-icon>close</mat-icon>
                  </div>
                </div>
              </ng-container>
              <ng-container *ngFor="let g of garments.footwear">
                <div
                  class="selection-thumb large clickable"
                  [matTooltip]="g.name + ' - Click to remove'"
                  (click)="toggleGarment(g)"
                >
                  <img [src]="g.image" [alt]="g.name" />
                  <span class="garment-type-badge">Shoes</span>
                  <div class="remove-indicator">
                    <mat-icon>close</mat-icon>
                  </div>
                </div>
              </ng-container>
              <ng-container *ngFor="let g of garments.accessories">
                <div
                  class="selection-thumb large clickable"
                  [matTooltip]="g.name + ' - Click to remove'"
                  (click)="toggleGarment(g)"
                >
                  <img [src]="g.image" [alt]="g.name" />
                  <span class="garment-type-badge">Acc</span>
                  <div class="remove-indicator">
                    <mat-icon>close</mat-icon>
                  </div>
                </div>
              </ng-container>
            </div>

            <!-- Empty state -->
            <div class="empty-selection" *ngIf="(selectedGarmentCount$ | async) === 0">
              <mat-icon>checkroom</mat-icon>
              <span>Select garments</span>
            </div>
          </ng-container>
        </div>

        <!-- Options Summary (Pose, Background, Ratio) -->
        <div class="selection-section options-summary" *ngIf="selectedPoseId() !== 'original' || hasBackgroundSelection() || selectedAspectRatio() !== 'original'">
          <span class="section-title-small">
            <mat-icon>tune</mat-icon>
            Options
          </span>
          <div class="options-chips">
            <div class="option-chip" *ngIf="selectedPoseId() !== 'original'">
              <mat-icon>accessibility_new</mat-icon>
              <span>{{ selectedPoseId() }}</span>
            </div>
            <div class="option-chip" *ngIf="hasBackgroundSelection()">
              <mat-icon>wallpaper</mat-icon>
              <span>{{ selectedPresetInfo?.name || 'Custom' }}</span>
            </div>
            <div class="option-chip" *ngIf="selectedAspectRatio() !== 'original'">
              <mat-icon>aspect_ratio</mat-icon>
              <span>{{ selectedAspectRatio() }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Credit cost indicator -->
      <div class="credit-cost" *ngIf="(selectedGarmentCount$ | async)! > 0 && (selectedModelCount$ | async)! > 0">
        <mat-icon>toll</mat-icon>
        <span>
          {{ generationCreditCost }} credits
          <span class="credit-breakdown" *ngIf="(selectedModelCount$ | async)! > 1">
            ({{ generationCreditCost / (selectedModelCount$ | async)! }} x {{ selectedModelCount$ | async }})
          </span>
        </span>
      </div>

      <!-- Generate button (desktop) -->
      <div
        class="generate-button-wrapper desktop-only"
        [matTooltip]="(canGenerate$ | async) ? '' : 'Select a model and at least one garment to generate'"
        matTooltipPosition="above"
      >
        <app-luxe-button
          class="generate-button"
          variant="primary"
          size="lg"
          [fullWidth]="true"
          [loading]="isGenerating()"
          [disabled]="!(canGenerate$ | async)"
          (clicked)="generateOutfit()"
        >
          <mat-icon>auto_awesome</mat-icon>
          {{ isGenerating() ? 'Generating...' : 'Generate Outfit' }}
        </app-luxe-button>
      </div>

      <!-- AI Disclaimer -->
      <app-ai-disclaimer variant="compact"></app-ai-disclaimer>
    </div>
  </aside>

  <!-- Generation Progress Overlay -->
  <app-generation-progress [isVisible]="isGenerating()"></app-generation-progress>

  <!-- Workflow Sections -->
  <main class="workflow-sections">
    <!-- Walkthrough Header (shows during full walkthrough) -->
    <div class="walkthrough-header" *ngIf="isFullWalkthrough()">
      <div class="walkthrough-progress">
        <span class="walkthrough-title">Studio Tour</span>
        <span class="walkthrough-step">Step {{ getWalkthroughStepNumber() }} of {{ getTotalWalkthroughSteps() }}</span>
      </div>
      <button class="walkthrough-skip-btn" (click)="skipWalkthrough()">
        Skip Tour
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Model Images Section -->
    <section class="workflow-section" #modelSection
      [class.tutorial-highlight]="(isTutorialActive() && tutorialStep() === 'model') || tutorialStep() === 'models-full'">
      <!-- Simplified flow: Pick a model -->
      <div class="tutorial-step-badge" *ngIf="isTutorialActive() && tutorialStep() === 'model'">
        <span class="step-number">1</span>
        <span class="step-text">Start here: Pick a model photo</span>
      </div>
      <!-- Full walkthrough: Explain model features -->
      <div class="walkthrough-tooltip" *ngIf="tutorialStep() === 'models-full'">
        <div class="tooltip-content">
          <mat-icon class="tooltip-icon">photo_camera</mat-icon>
          <div class="tooltip-text">
            <h4>Upload Your Own Photos</h4>
            <p>Use the <strong>upload button</strong> to add your own photos, or choose from our <strong>template models</strong>. Full-body shots work best!</p>
          </div>
        </div>
        <button class="tooltip-next-btn" (click)="nextWalkthroughStep()">
          Got it
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
      <div class="section-header-row">
        <h2 class="section-label-gold">Model Images</h2>
        <div class="section-actions">
          <button
            class="template-toggle-btn"
            [class.active]="showTemplates()"
            (click)="toggleShowTemplates()"
            [matTooltip]="showTemplates() ? 'Hide preloaded templates' : 'Show preloaded templates'"
            aria-label="Toggle preloaded template visibility"
          >
            <mat-icon>{{ showTemplates() ? 'visibility' : 'visibility_off' }}</mat-icon>
            <span class="toggle-label">Templates</span>
          </button>
          <button
            class="archive-btn-small"
            (click)="openArchivePanel()"
            matTooltip="View archived items"
            aria-label="View archived model images"
          >
            <mat-icon>inventory_2</mat-icon>
          </button>
          <button
            class="upload-btn-small"
            (click)="modelUploadInput.click()"
            aria-label="Upload model image"
            matTooltip="Upload model image"
          >
            <mat-icon>add_photo_alternate</mat-icon>
            <mat-spinner *ngIf="isUploadingModel()" [diameter]="16"></mat-spinner>
          </button>
        </div>
        <input
          #modelUploadInput
          type="file"
          accept="image/*"
          multiple
          (change)="handleModelUpload($event)"
          hidden
        />
      </div>

      <ng-container *ngIf="originalModelImages$ | async as models">
        <!-- Mobile: Carousel view -->
        <app-luxe-carousel
          class="mobile-carousel"
          [showCount]="false"
          [itemCount]="models.length"
          gap="0.75rem"
        >
          <div class="model-card-wrapper carousel-item" *ngFor="let model of models">
            <app-luxe-image-card
              [src]="model.previewUrl || model.remoteUrl"
              [selected]="isModelSelected(model)"
              aspectRatio="3:4"
              (cardClick)="selectModel(model)"
            ></app-luxe-image-card>
            <!-- Selection badge showing order number -->
            <span class="selection-badge" *ngIf="getModelSelectionBadge(model) as badge">{{ badge }}</span>
            <button
              class="card-archive-btn"
              (click)="archiveModelImage($event, model)"
              matTooltip="Archive"
              *ngIf="model.id"
            >
              <mat-icon>archive</mat-icon>
            </button>
          </div>
          <!-- Upload card in carousel -->
          <div class="upload-card-wrapper carousel-item">
            <button class="upload-card" (click)="modelUploadInput.click()">
              <mat-icon>add_photo_alternate</mat-icon>
              <span>Add</span>
            </button>
          </div>
        </app-luxe-carousel>

        <!-- Desktop: Grid view -->
        <div class="model-grid desktop-grid">
          <div class="model-card-wrapper" *ngFor="let model of models">
            <app-luxe-image-card
              [src]="model.previewUrl || model.remoteUrl"
              [selected]="isModelSelected(model)"
              aspectRatio="3:4"
              (cardClick)="selectModel(model)"
            ></app-luxe-image-card>
            <!-- Selection badge showing order number -->
            <span class="selection-badge" *ngIf="getModelSelectionBadge(model) as badge">{{ badge }}</span>
            <button
              class="card-archive-btn"
              (click)="archiveModelImage($event, model)"
              matTooltip="Archive"
              *ngIf="model.id"
            >
              <mat-icon>archive</mat-icon>
            </button>
          </div>
          <button class="upload-card" (click)="modelUploadInput.click()">
            <mat-icon>add_photo_alternate</mat-icon>
            <span>Upload</span>
            <mat-spinner *ngIf="isUploadingModel()" [diameter]="24"></mat-spinner>
          </button>
        </div>

        <!-- Empty state - Enhanced with guidance (#2, #9, #28) -->
        <div class="empty-hint enhanced" *ngIf="models.length === 0">
          <mat-icon>person_outline</mat-icon>
          <h4>Upload Your Photos</h4>
          <p>Full body photos work best. You can upload multiple images at once.</p>
          <ul class="upload-tips">
            <li>Clear, well-lit photos</li>
            <li>Standing full-body shots</li>
            <li>Multiple angles welcome</li>
          </ul>
          <button class="upload-card compact" (click)="modelUploadInput.click()">
            <mat-icon>add_photo_alternate</mat-icon>
            <span>Upload Photos</span>
          </button>
        </div>
      </ng-container>
    </section>

    <!-- Advanced Options Toggle (shown in simplified tutorial mode only) -->
    <div class="advanced-options-toggle" *ngIf="isSimplifiedFlow() && !showAdvancedOptions()">
      <button class="show-advanced-btn" (click)="expandAdvancedOptions()">
        <mat-icon>tune</mat-icon>
        <span>Show advanced options (pose, background, aspect ratio)</span>
        <mat-icon class="expand-icon">expand_more</mat-icon>
      </button>
    </div>

    <!-- Pose Section (Optional - pre-defined poses) -->
    <section class="workflow-section pose-section" #poseSection
      [class.tutorial-highlight]="tutorialStep() === 'pose-full'"
      *ngIf="showAdvancedOptions() || !isSimplifiedFlow()">
      <!-- Full walkthrough: Explain pose options -->
      <div class="walkthrough-tooltip" *ngIf="tutorialStep() === 'pose-full'">
        <div class="tooltip-content">
          <mat-icon class="tooltip-icon">accessibility_new</mat-icon>
          <div class="tooltip-text">
            <h4>Change the Pose</h4>
            <p>Transform the model's pose! Choose from <strong>confident</strong>, <strong>casual</strong>, <strong>dynamic</strong>, or <strong>elegant</strong> poses to match your vision.</p>
          </div>
        </div>
        <button class="tooltip-next-btn" (click)="nextWalkthroughStep()">
          Got it
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
      <div class="section-header-row">
        <h2 class="section-label-gold">Pose <span class="optional-tag">(Optional)</span></h2>
      </div>

      <div class="pose-preset-grid">
        <button
          class="pose-tile"
          *ngFor="let pose of posePresets"
          [class.selected]="isPoseSelected(pose.id)"
          (click)="selectPose(pose.id)"
        >
          <span class="pose-name">{{ pose.name }}</span>
          <mat-icon class="pose-check" *ngIf="isPoseSelected(pose.id)">check_circle</mat-icon>
        </button>
      </div>
    </section>

    <!-- Background Section (Optional - AI-generated or uploaded) -->
    <section class="workflow-section background-section" #backgroundSection
      [class.tutorial-highlight]="tutorialStep() === 'background-full'"
      *ngIf="showAdvancedOptions() || !isSimplifiedFlow()">
      <!-- Full walkthrough: Explain background options -->
      <div class="walkthrough-tooltip" *ngIf="tutorialStep() === 'background-full'">
        <div class="tooltip-content">
          <mat-icon class="tooltip-icon">wallpaper</mat-icon>
          <div class="tooltip-text">
            <h4>Set the Scene</h4>
            <p>Choose from <strong>150+ background presets</strong> across categories like Studio, Urban, Outdoor, and Luxury â€” or write your own <strong>custom description</strong>!</p>
          </div>
        </div>
        <button class="tooltip-next-btn" (click)="nextWalkthroughStep()">
          Got it
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
      <div class="section-header-row">
        <h2 class="section-label-gold">Background <span class="optional-tag">(Optional)</span></h2>
      </div>

      <!-- Selected Background Indicator -->
      <div class="selected-background-indicator" *ngIf="selectedPresetInfo">
        <div class="indicator-content">
          <mat-icon>wallpaper</mat-icon>
          <div class="indicator-text">
            <span class="indicator-name">{{ selectedPresetInfo.name }}</span>
            <span class="indicator-category">{{ selectedPresetInfo.category }}</span>
          </div>
        </div>
        <button class="indicator-clear" (click)="clearBackgroundSelection()" matTooltip="Clear selection">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <!-- Category Cards Grid -->
      <div class="background-category-grid">
        <button
          *ngFor="let cat of backgroundCategories"
          class="category-card"
          [class.expanded]="isCategoryExpanded(cat.id)"
          [class.has-selection]="activeBackgroundCategory() === cat.id && hasBackgroundSelection()"
          (click)="selectBackgroundCategory(cat.id)"
        >
          <span class="category-name">{{ cat.label }}</span>
          <span class="category-desc">{{ cat.description }}</span>
          <mat-icon class="category-expand-icon">{{ isCategoryExpanded(cat.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
      </div>

      <!-- Expanded Category Content -->
      <div class="category-expanded-content" #backgroundExpandedContent *ngIf="expandedCategory() && expandedCategory() !== 'original'">
        <!-- Preset Grid -->
        <div class="background-preset-grid">
          <button
            class="preset-tile"
            *ngFor="let preset of filteredPresets"
            [class.selected]="isPresetSelected(preset.id)"
            (click)="selectPreset(preset)"
          >
            <span class="preset-name">{{ preset.name }}</span>
            <mat-icon class="preset-check" *ngIf="isPresetSelected(preset.id)">check_circle</mat-icon>
          </button>
        </div>

        <!-- Custom Prompt -->
        <div class="custom-prompt-section">
          <label class="prompt-label">Or describe a custom background</label>
          <textarea
            class="custom-prompt-input"
            [value]="customBackgroundPrompt()"
            (input)="onCustomPromptChange($any($event.target).value)"
            placeholder="e.g., modern minimalist living room with large windows and natural light"
            rows="2"
          ></textarea>
        </div>
      </div>

      <!-- Original Category Expanded (empty state) -->
      <div class="category-expanded-content original-expanded" *ngIf="expandedCategory() === 'original'">
        <div class="original-empty-state">
          <mat-icon>photo_camera</mat-icon>
          <p>The original background from your model image will be preserved</p>
        </div>
      </div>
    </section>

    <!-- Aspect Ratio Section -->
    <section class="workflow-section aspect-ratio-section" #aspectRatioSection
      [class.tutorial-highlight]="tutorialStep() === 'aspect-ratio-full'"
      *ngIf="showAdvancedOptions() || !isSimplifiedFlow()">
      <!-- Full walkthrough: Explain aspect ratio options -->
      <div class="walkthrough-tooltip" *ngIf="tutorialStep() === 'aspect-ratio-full'">
        <div class="tooltip-content">
          <mat-icon class="tooltip-icon">aspect_ratio</mat-icon>
          <div class="tooltip-text">
            <h4>Choose Your Format</h4>
            <p>Select the perfect aspect ratio for your needs: <strong>Square</strong> for Instagram, <strong>9:16</strong> for Stories, or keep the <strong>Original</strong> dimensions.</p>
          </div>
        </div>
        <button class="tooltip-next-btn" (click)="nextWalkthroughStep()">
          Got it
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
      <div class="section-header-row">
        <h2 class="section-label-gold">Aspect Ratio</h2>
      </div>

      <div class="aspect-ratio-options">
        <button
          class="aspect-ratio-btn"
          *ngFor="let option of aspectRatioOptions"
          [class.selected]="selectedAspectRatio() === option.value"
          (click)="selectAspectRatio(option.value)"
        >
          {{ option.label }}
        </button>
      </div>
    </section>

    <!-- Garments Section -->
    <section class="workflow-section" #garmentsSection
      [class.tutorial-highlight]="tutorialStep() === 'garment' || tutorialStep() === 'garments-full'">
      <!-- Simplified flow: Pick garments -->
      <div class="tutorial-step-badge" *ngIf="tutorialStep() === 'garment'">
        <span class="step-number">2</span>
        <span class="step-text">Now pick some clothes to try on</span>
      </div>
      <!-- Full walkthrough: Explain garment features -->
      <div class="walkthrough-tooltip walkthrough-complete" *ngIf="tutorialStep() === 'garments-full'">
        <div class="tooltip-content">
          <mat-icon class="tooltip-icon">checkroom</mat-icon>
          <div class="tooltip-text">
            <h4>Add Your Own Garments</h4>
            <p>Upload photos of any clothing item using the <strong>Add Garment</strong> button. Mix tops, bottoms, jackets, and accessories to create the perfect outfit!</p>
          </div>
        </div>
        <button class="tooltip-next-btn tooltip-finish-btn" (click)="nextWalkthroughStep()">
          Finish Tour
          <mat-icon>check</mat-icon>
        </button>
      </div>
      <div class="section-header-row">
        <h2 class="section-label-gold">Garments</h2>
        <div class="section-actions">
          <button
            class="template-toggle-btn"
            [class.active]="showTemplateGarments()"
            (click)="toggleShowTemplateGarments()"
            [matTooltip]="showTemplateGarments() ? 'Hide preloaded template garments' : 'Show preloaded template garments'"
            aria-label="Toggle preloaded template garment visibility"
          >
            <mat-icon>{{ showTemplateGarments() ? 'visibility' : 'visibility_off' }}</mat-icon>
            <span class="toggle-label">Templates</span>
          </button>
          <button
            class="clear-btn-small"
            *ngIf="(selectedGarmentCount$ | async)! > 0"
            (click)="clearAllGarments()"
            matTooltip="Clear all selected garments"
            aria-label="Clear all garments"
          >
            <mat-icon>clear_all</mat-icon>
            <span class="clear-label">Clear</span>
          </button>
          <button
            class="archive-btn-small"
            (click)="openArchivePanel()"
            matTooltip="View archived items"
            aria-label="View archived garments"
          >
            <mat-icon>inventory_2</mat-icon>
          </button>
          <app-luxe-button
            variant="secondary"
            size="sm"
            icon="add_photo_alternate"
            (clicked)="openGarmentUploadDialog()"
          >
            Add Garment
          </app-luxe-button>
        </div>
      </div>

      <!-- Garment Carousels by Category -->
      <ng-container *ngIf="garmentsByGroup$ | async as groups">
        <ng-container *ngIf="selectedGarments$ | async as selected">
          <div *ngFor="let group of garmentGroups" class="garment-category">
            <ng-container *ngIf="groups[group.key]?.length">
              <!-- Category header with clear button -->
              <div class="category-header-row">
                <h3 class="category-label">{{ group.label }}</h3>
                <span class="category-count">{{ groups[group.key].length }} items</span>
                <button
                  class="category-clear-btn"
                  *ngIf="(group.key === 'tops' && selected.top.length > 0) ||
                         (group.key === 'bottoms' && selected.bottom.length > 0) ||
                         (group.key === 'full-body' && selected.fullBody.length > 0) ||
                         (group.key === 'jackets' && selected.jacket.length > 0) ||
                         (group.key === 'footwear' && selected.footwear.length > 0) ||
                         (group.key === 'accessories' && selected.accessories.length > 0)"
                  (click)="clearGarmentCategory($event, group.key)"
                  matTooltip="Clear {{ group.label | lowercase }}"
                  [attr.aria-label]="'Clear ' + group.label"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
              <app-luxe-carousel
                [showCount]="false"
                [itemCount]="groups[group.key].length"
                gap="1rem"
              >
                <div class="garment-card-wrapper" *ngFor="let garment of groups[group.key]">
                  <app-luxe-image-card
                    class="garment-card"
                    [src]="garment.image"
                    [selected]="isGarmentSelected(garment)"
                    aspectRatio="3:4"
                    (cardClick)="toggleGarment(garment)"
                  ></app-luxe-image-card>
                  <button
                    class="card-archive-btn"
                    (click)="archiveGarment($event, garment)"
                    matTooltip="Archive"
                  >
                    <mat-icon>archive</mat-icon>
                  </button>
                </div>
              </app-luxe-carousel>
            </ng-container>
          </div>
        </ng-container>
      </ng-container>

      <!-- Empty state when no garments - Enhanced with guidance (#2, #9, #28) -->
      <div class="empty-garments" *ngIf="(garments$ | async)?.length === 0">
        <mat-icon>checkroom</mat-icon>
        <h4>Add Your Garments</h4>
        <p>Upload photos of clothing items you want to try on virtually.</p>
        <ul class="upload-tips">
          <li>Flat lay photos work best</li>
          <li>Plain backgrounds preferred</li>
          <li>Upload multiple items at once</li>
        </ul>
        <app-luxe-button
          variant="primary"
          icon="add_photo_alternate"
          (clicked)="openGarmentUploadDialog()"
        >
          Add Garment
        </app-luxe-button>
      </div>
    </section>

  </main>

</div>

<!-- ============================================== -->
<!-- MOBILE STUDIO LAYOUT (hidden on desktop)      -->
<!-- ============================================== -->
<div class="mobile-studio">
  <!-- Selected Items Bar (sticky top) -->
  <div class="mobile-selected-bar">
    <ng-container *ngIf="selectedModels$ | async as models">
      <ng-container *ngIf="selectedGarments$ | async as garments">
        <!-- Show selected items or empty state -->
        <div class="selected-items-scroll" *ngIf="models.length > 0 || (selectedGarmentCount$ | async)! > 0 || selectedPoseId() !== 'original' || hasBackgroundSelection() || selectedAspectRatio() !== 'original'">
          <!-- Selected Models -->
          <div
            class="selected-item"
            *ngFor="let model of models"
            (click)="selectModel(model)"
          >
            <img [src]="model.previewUrl || model.remoteUrl" [alt]="model.name || 'Model'" />
            <span class="item-type">Model</span>
            <div class="remove-badge"><mat-icon>close</mat-icon></div>
          </div>

          <!-- Selected Pose (if not original) -->
          <div
            class="selected-item selected-option"
            *ngIf="selectedPoseId() !== 'original'"
            (click)="selectPose('original')"
          >
            <mat-icon class="option-icon">accessibility_new</mat-icon>
            <span class="option-label">{{ selectedPoseId() }}</span>
            <div class="remove-badge"><mat-icon>close</mat-icon></div>
          </div>

          <!-- Selected Background (if set) -->
          <div
            class="selected-item selected-option"
            *ngIf="hasBackgroundSelection()"
            (click)="clearBackgroundSelection()"
          >
            <mat-icon class="option-icon">wallpaper</mat-icon>
            <span class="option-label">{{ selectedPresetInfo?.name || 'Custom' }}</span>
            <div class="remove-badge"><mat-icon>close</mat-icon></div>
          </div>

          <!-- Selected Aspect Ratio (if not original) -->
          <div
            class="selected-item selected-option"
            *ngIf="selectedAspectRatio() !== 'original'"
            (click)="clearAspectRatio()"
          >
            <mat-icon class="option-icon">aspect_ratio</mat-icon>
            <span class="option-label">{{ selectedAspectRatio() }}</span>
            <div class="remove-badge"><mat-icon>close</mat-icon></div>
          </div>

          <!-- Selected Garments -->
          <ng-container *ngFor="let g of garments.top">
            <div class="selected-item" (click)="toggleGarment(g)">
              <img [src]="g.image" [alt]="g.name" />
              <span class="item-type">Top</span>
              <div class="remove-badge"><mat-icon>close</mat-icon></div>
            </div>
          </ng-container>
          <ng-container *ngFor="let g of garments.bottom">
            <div class="selected-item" (click)="toggleGarment(g)">
              <img [src]="g.image" [alt]="g.name" />
              <span class="item-type">Bottom</span>
              <div class="remove-badge"><mat-icon>close</mat-icon></div>
            </div>
          </ng-container>
          <ng-container *ngFor="let g of garments.fullBody">
            <div class="selected-item" (click)="toggleGarment(g)">
              <img [src]="g.image" [alt]="g.name" />
              <span class="item-type">Full</span>
              <div class="remove-badge"><mat-icon>close</mat-icon></div>
            </div>
          </ng-container>
          <ng-container *ngFor="let g of garments.jacket">
            <div class="selected-item" (click)="toggleGarment(g)">
              <img [src]="g.image" [alt]="g.name" />
              <span class="item-type">Jacket</span>
              <div class="remove-badge"><mat-icon>close</mat-icon></div>
            </div>
          </ng-container>
          <ng-container *ngFor="let g of garments.footwear">
            <div class="selected-item" (click)="toggleGarment(g)">
              <img [src]="g.image" [alt]="g.name" />
              <span class="item-type">Shoes</span>
              <div class="remove-badge"><mat-icon>close</mat-icon></div>
            </div>
          </ng-container>
          <ng-container *ngFor="let g of garments.accessories">
            <div class="selected-item" (click)="toggleGarment(g)">
              <img [src]="g.image" [alt]="g.name" />
              <span class="item-type">Acc</span>
              <div class="remove-badge"><mat-icon>close</mat-icon></div>
            </div>
          </ng-container>
        </div>

        <!-- Empty state -->
        <div class="selected-empty" *ngIf="models.length === 0 && (selectedGarmentCount$ | async) === 0 && selectedPoseId() === 'original' && !hasBackgroundSelection() && selectedAspectRatio() === 'original'">
          <mat-icon>touch_app</mat-icon>
          <span>Tap below to build your outfit</span>
        </div>
      </ng-container>
    </ng-container>
  </div>

  <!-- Content Area -->
  <div class="mobile-content">
    <!-- MODEL SECTION -->
    <div class="mobile-section" *ngIf="mobileActiveSection() === 'model'">
      <!-- Tutorial hint for model selection -->
      <div class="mobile-tutorial-hint" *ngIf="tutorialStep() === 'model'">
        <div class="tutorial-hint-content">
          <mat-icon class="hint-icon">touch_app</mat-icon>
          <span>Tap a model photo to select it. You can choose up to 5.</span>
        </div>
      </div>
      <div class="section-toolbar">
        <button
          class="toolbar-btn"
          [class.active]="showTemplates()"
          (click)="toggleShowTemplates()"
        >
          <mat-icon>{{ showTemplates() ? 'visibility' : 'visibility_off' }}</mat-icon>
          Templates
        </button>
        <button class="toolbar-btn primary" (click)="modelUploadInput.click()">
          <mat-icon>add_photo_alternate</mat-icon>
          Upload
        </button>
      </div>
      <div class="mobile-grid" [class.tutorial-active]="tutorialStep() === 'model'">
        <ng-container *ngIf="originalModelImages$ | async as models">
          <div
            class="mobile-grid-item"
            *ngFor="let model of models; let i = index"
            [class.selected]="isModelSelected(model)"
            [class.tutorial-pulse]="tutorialStep() === 'model' && i === 0 && !isModelSelected(model)"
            (click)="selectModel(model)"
          >
            <img [src]="model.previewUrl || model.remoteUrl" [alt]="model.name || 'Model'" />
            <div class="selected-check" *ngIf="isModelSelected(model)">
              <mat-icon>check</mat-icon>
            </div>
          </div>
        </ng-container>
      </div>
    </div>

    <!-- POSE SECTION -->
    <div class="mobile-section" *ngIf="mobileActiveSection() === 'pose'">
      <div class="mobile-grid poses">
        <div
          class="mobile-grid-item pose-item"
          *ngFor="let pose of posePresets"
          [class.selected]="isPoseSelected(pose.id)"
          (click)="selectPose(pose.id)"
        >
          <mat-icon class="pose-icon">accessibility_new</mat-icon>
          <span class="pose-name">{{ pose.name }}</span>
          <div class="selected-check" *ngIf="isPoseSelected(pose.id)">
            <mat-icon>check</mat-icon>
          </div>
        </div>
      </div>
    </div>

    <!-- BACKGROUND SECTION -->
    <div class="mobile-section" *ngIf="mobileActiveSection() === 'background'">
      <!-- Category pills -->
      <div class="category-pills">
        <button
          class="category-pill"
          *ngFor="let cat of backgroundCategories"
          [class.active]="expandedCategory() === cat.id"
          (click)="selectBackgroundCategory(cat.id)"
        >
          {{ cat.label }}
        </button>
      </div>
      <!-- Presets grid -->
      <div class="mobile-grid backgrounds" *ngIf="expandedCategory() && expandedCategory() !== 'original'">
        <div
          class="mobile-grid-item bg-item"
          *ngFor="let preset of filteredPresets"
          [class.selected]="isPresetSelected(preset.id)"
          (click)="selectPreset(preset)"
        >
          <mat-icon class="bg-icon">wallpaper</mat-icon>
          <span class="bg-name">{{ preset.name }}</span>
          <div class="selected-check" *ngIf="isPresetSelected(preset.id)">
            <mat-icon>check</mat-icon>
          </div>
        </div>
      </div>
      <!-- Original selected message -->
      <div class="original-state" *ngIf="expandedCategory() === 'original'">
        <mat-icon>photo_camera</mat-icon>
        <p>Keep the original background from your photo</p>
      </div>
      <!-- Custom prompt -->
      <div class="custom-prompt-mobile" *ngIf="expandedCategory() && expandedCategory() !== 'original'">
        <label>Or describe a custom background:</label>
        <textarea
          [value]="customBackgroundPrompt()"
          (input)="onCustomPromptChange($any($event.target).value)"
          placeholder="e.g., A sunny beach at sunset..."
          rows="2"
        ></textarea>
      </div>
    </div>

    <!-- RATIO SECTION -->
    <div class="mobile-section" *ngIf="mobileActiveSection() === 'ratio'">
      <div class="mobile-grid ratios">
        <div
          class="mobile-grid-item ratio-item"
          *ngFor="let option of aspectRatioOptions"
          [class.selected]="selectedAspectRatio() === option.value"
          (click)="selectAspectRatio(option.value)"
        >
          <div class="ratio-preview" [attr.data-ratio]="option.value"></div>
          <span class="ratio-label">{{ option.label }}</span>
          <div class="selected-check" *ngIf="selectedAspectRatio() === option.value">
            <mat-icon>check</mat-icon>
          </div>
        </div>
      </div>
    </div>

    <!-- GARMENTS SECTION -->
    <div class="mobile-section" *ngIf="mobileActiveSection() === 'garments'">
      <!-- Tutorial hint for garment selection -->
      <div class="mobile-tutorial-hint" *ngIf="tutorialStep() === 'garment'">
        <div class="tutorial-hint-content">
          <mat-icon class="hint-icon">checkroom</mat-icon>
          <span>Choose what garments you wish to try on</span>
        </div>
      </div>
      <!-- Sub-category tabs -->
      <div class="garment-category-tabs">
        <button
          class="garment-tab"
          [class.active]="mobileGarmentCategory() === 'all'"
          (click)="setMobileGarmentCategory('all')"
        >
          All
        </button>
        <button
          class="garment-tab"
          [class.active]="mobileGarmentCategory() === 'tops'"
          (click)="setMobileGarmentCategory('tops')"
        >
          Tops
          <span class="tab-badge" *ngIf="(selectedGarments$ | async)?.top?.length">{{ (selectedGarments$ | async)?.top?.length }}</span>
        </button>
        <button
          class="garment-tab"
          [class.active]="mobileGarmentCategory() === 'bottoms'"
          (click)="setMobileGarmentCategory('bottoms')"
        >
          Bottoms
          <span class="tab-badge" *ngIf="(selectedGarments$ | async)?.bottom?.length">{{ (selectedGarments$ | async)?.bottom?.length }}</span>
        </button>
        <button
          class="garment-tab"
          [class.active]="mobileGarmentCategory() === 'full-body'"
          (click)="setMobileGarmentCategory('full-body')"
        >
          Full
          <span class="tab-badge" *ngIf="(selectedGarments$ | async)?.fullBody?.length">{{ (selectedGarments$ | async)?.fullBody?.length }}</span>
        </button>
        <button
          class="garment-tab"
          [class.active]="mobileGarmentCategory() === 'jackets'"
          (click)="setMobileGarmentCategory('jackets')"
        >
          Jackets
          <span class="tab-badge" *ngIf="(selectedGarments$ | async)?.jacket?.length">{{ (selectedGarments$ | async)?.jacket?.length }}</span>
        </button>
        <button
          class="garment-tab"
          [class.active]="mobileGarmentCategory() === 'footwear'"
          (click)="setMobileGarmentCategory('footwear')"
        >
          Shoes
          <span class="tab-badge" *ngIf="(selectedGarments$ | async)?.footwear?.length">{{ (selectedGarments$ | async)?.footwear?.length }}</span>
        </button>
        <button
          class="garment-tab"
          [class.active]="mobileGarmentCategory() === 'accessories'"
          (click)="setMobileGarmentCategory('accessories')"
        >
          Acc
          <span class="tab-badge" *ngIf="(selectedGarments$ | async)?.accessories?.length">{{ (selectedGarments$ | async)?.accessories?.length }}</span>
        </button>
      </div>

      <!-- Garment toolbar -->
      <div class="section-toolbar">
        <button
          class="toolbar-btn"
          [class.active]="showTemplateGarments()"
          (click)="toggleShowTemplateGarments()"
        >
          <mat-icon>{{ showTemplateGarments() ? 'visibility' : 'visibility_off' }}</mat-icon>
          Templates
        </button>
        <button class="toolbar-btn primary" (click)="openGarmentUploadDialog()">
          <mat-icon>add_photo_alternate</mat-icon>
          Add Garment
        </button>
      </div>

      <!-- Garments grid -->
      <ng-container *ngIf="garmentsByGroup$ | async as groups">
        <div class="mobile-grid garments" [class.tutorial-active]="tutorialStep() === 'garment'">
          <!-- All category -->
          <ng-container *ngIf="mobileGarmentCategory() === 'all'">
            <ng-container *ngFor="let g of groups['tops']; let gi = index">
              <div
                class="mobile-grid-item"
                [class.selected]="isGarmentSelected(g)"
                [class.tutorial-pulse]="tutorialStep() === 'garment' && gi === 0 && !isGarmentSelected(g)"
                (click)="toggleGarment(g)"
              >
                <img [src]="g.image" [alt]="g.name" />
                <span class="garment-badge">Top</span>
                <div class="selected-check" *ngIf="isGarmentSelected(g)">
                  <mat-icon>check</mat-icon>
                </div>
              </div>
            </ng-container>
            <ng-container *ngFor="let g of groups['bottoms']">
              <div
                class="mobile-grid-item"
                [class.selected]="isGarmentSelected(g)"
                (click)="toggleGarment(g)"
              >
                <img [src]="g.image" [alt]="g.name" />
                <span class="garment-badge">Bottom</span>
                <div class="selected-check" *ngIf="isGarmentSelected(g)">
                  <mat-icon>check</mat-icon>
                </div>
              </div>
            </ng-container>
            <ng-container *ngFor="let g of groups['full-body']">
              <div
                class="mobile-grid-item"
                [class.selected]="isGarmentSelected(g)"
                (click)="toggleGarment(g)"
              >
                <img [src]="g.image" [alt]="g.name" />
                <span class="garment-badge">Full</span>
                <div class="selected-check" *ngIf="isGarmentSelected(g)">
                  <mat-icon>check</mat-icon>
                </div>
              </div>
            </ng-container>
            <ng-container *ngFor="let g of groups['jackets']">
              <div
                class="mobile-grid-item"
                [class.selected]="isGarmentSelected(g)"
                (click)="toggleGarment(g)"
              >
                <img [src]="g.image" [alt]="g.name" />
                <span class="garment-badge">Jacket</span>
                <div class="selected-check" *ngIf="isGarmentSelected(g)">
                  <mat-icon>check</mat-icon>
                </div>
              </div>
            </ng-container>
            <ng-container *ngFor="let g of groups['footwear']">
              <div
                class="mobile-grid-item"
                [class.selected]="isGarmentSelected(g)"
                (click)="toggleGarment(g)"
              >
                <img [src]="g.image" [alt]="g.name" />
                <span class="garment-badge">Shoes</span>
                <div class="selected-check" *ngIf="isGarmentSelected(g)">
                  <mat-icon>check</mat-icon>
                </div>
              </div>
            </ng-container>
            <ng-container *ngFor="let g of groups['accessories']">
              <div
                class="mobile-grid-item"
                [class.selected]="isGarmentSelected(g)"
                (click)="toggleGarment(g)"
              >
                <img [src]="g.image" [alt]="g.name" />
                <span class="garment-badge">Acc</span>
                <div class="selected-check" *ngIf="isGarmentSelected(g)">
                  <mat-icon>check</mat-icon>
                </div>
              </div>
            </ng-container>
          </ng-container>

          <!-- Specific category -->
          <ng-container *ngIf="mobileGarmentCategory() !== 'all'">
            <ng-container *ngFor="let g of groups[getMobileGarmentCategory()]">
              <div
                class="mobile-grid-item"
                [class.selected]="isGarmentSelected(g)"
                (click)="toggleGarment(g)"
              >
                <img [src]="g.image" [alt]="g.name" />
                <div class="selected-check" *ngIf="isGarmentSelected(g)">
                  <mat-icon>check</mat-icon>
                </div>
              </div>
            </ng-container>
          </ng-container>
        </div>

        <!-- Empty state for category -->
        <div class="empty-category" *ngIf="mobileGarmentCategory() !== 'all' && (!groups[getMobileGarmentCategory()] || groups[getMobileGarmentCategory()].length === 0)">
          <mat-icon>checkroom</mat-icon>
          <p>No {{ mobileGarmentCategory() }} yet</p>
          <button class="add-btn" (click)="openGarmentUploadDialog()">Add Garment</button>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Mobile Walkthrough Header (shows during full walkthrough) -->
  <div class="mobile-walkthrough-header" *ngIf="isFullWalkthrough()">
    <div class="walkthrough-info">
      <span class="walkthrough-title">Studio Tour</span>
      <span class="walkthrough-step">{{ getWalkthroughStepNumber() }}/{{ getTotalWalkthroughSteps() }}</span>
    </div>
    <button class="walkthrough-skip" (click)="skipWalkthrough()">Skip</button>
  </div>

  <!-- Section Tabs (bottom navigation) -->
  <div class="mobile-section-tabs" [class.tutorial-active]="isTutorialActive()">
    <!-- Model Tab -->
    <button
      class="section-tab"
      [class.active]="mobileActiveSection() === 'model'"
      [class.tutorial-highlight]="tutorialStep() === 'model' || tutorialStep() === 'models-full'"
      (click)="onMobileTabClick('model')"
    >
      <mat-icon>person</mat-icon>
      <span>Model</span>
      <span class="tab-count" *ngIf="(selectedModelCount$ | async)! > 0">{{ selectedModelCount$ | async }}</span>
      <div class="mobile-tab-tooltip walkthrough" *ngIf="tutorialStep() === 'models-full'">
        <span>Upload your own photos or use templates</span>
        <button class="tooltip-next" (click)="nextMobileWalkthroughStep($event)">Next</button>
        <div class="tooltip-arrow"></div>
      </div>
    </button>

    <!-- Pose Tab -->
    <button
      class="section-tab"
      [class.active]="mobileActiveSection() === 'pose'"
      [class.tutorial-highlight]="tutorialStep() === 'pose-full'"
      (click)="onMobileTabClick('pose')"
    >
      <mat-icon>accessibility_new</mat-icon>
      <span>Pose</span>
      <span class="tab-dot" *ngIf="selectedPoseId() !== 'original'"></span>
      <div class="mobile-tab-tooltip walkthrough" *ngIf="tutorialStep() === 'pose-full'">
        <span>Change the model's pose</span>
        <button class="tooltip-next" (click)="nextMobileWalkthroughStep($event)">Next</button>
        <div class="tooltip-arrow"></div>
      </div>
    </button>

    <!-- Background Tab -->
    <button
      class="section-tab"
      [class.active]="mobileActiveSection() === 'background'"
      [class.tutorial-highlight]="tutorialStep() === 'background-full'"
      (click)="onMobileTabClick('background')"
    >
      <mat-icon>wallpaper</mat-icon>
      <span>Scene</span>
      <span class="tab-dot" *ngIf="hasBackgroundSelection()"></span>
      <div class="mobile-tab-tooltip walkthrough" *ngIf="tutorialStep() === 'background-full'">
        <span>Set the background scene</span>
        <button class="tooltip-next" (click)="nextMobileWalkthroughStep($event)">Next</button>
        <div class="tooltip-arrow"></div>
      </div>
    </button>

    <!-- Ratio Tab -->
    <button
      class="section-tab"
      [class.active]="mobileActiveSection() === 'ratio'"
      [class.tutorial-highlight]="tutorialStep() === 'aspect-ratio-full'"
      (click)="onMobileTabClick('ratio')"
    >
      <mat-icon>aspect_ratio</mat-icon>
      <span>Ratio</span>
      <div class="mobile-tab-tooltip walkthrough" *ngIf="tutorialStep() === 'aspect-ratio-full'">
        <span>Choose output format</span>
        <button class="tooltip-next" (click)="nextMobileWalkthroughStep($event)">Next</button>
        <div class="tooltip-arrow"></div>
      </div>
    </button>

    <!-- Garments Tab -->
    <button
      class="section-tab"
      [class.active]="mobileActiveSection() === 'garments'"
      [class.tutorial-highlight]="tutorialStep() === 'garment' || tutorialStep() === 'garments-full'"
      (click)="onMobileTabClick('garments')"
    >
      <mat-icon>checkroom</mat-icon>
      <span>Clothes</span>
      <span class="tab-count" *ngIf="(selectedGarmentCount$ | async)! > 0">{{ selectedGarmentCount$ | async }}</span>
      <div class="mobile-tab-tooltip walkthrough finish" *ngIf="tutorialStep() === 'garments-full'">
        <span>Add your own garments</span>
        <button class="tooltip-next" (click)="nextMobileWalkthroughStep($event)">Done</button>
        <div class="tooltip-arrow"></div>
      </div>
    </button>
  </div>

  <!-- Generate Button -->
  <div class="mobile-generate">
    <!-- Tutorial tooltip for generate button -->
    <div class="generate-tutorial-tooltip" *ngIf="tutorialStep() === 'garment' && (selectedGarmentCount$ | async)! > 0">
      <span>Click here to generate your outfit once you have chosen your garments</span>
      <div class="tooltip-arrow"></div>
    </div>
    <app-luxe-button
      variant="primary"
      size="lg"
      [fullWidth]="true"
      [loading]="isGenerating()"
      [disabled]="!(canGenerate$ | async)"
      (clicked)="generateOutfit()"
    >
      <span class="mobile-generate-content">
        <span>{{ isGenerating() ? 'Generating...' : 'Generate Outfit' }}</span>
        <span class="mobile-credit-cost" *ngIf="!isGenerating() && (canGenerate$ | async)">
          <mat-icon>toll</mat-icon>
          {{ generationCreditCost }}
        </span>
      </span>
    </app-luxe-button>
  </div>

  <!-- AI Disclaimer (mobile) -->
  <app-ai-disclaimer variant="compact"></app-ai-disclaimer>
</div>

<!-- Archive Panel -->
<app-archive-panel
  [isOpen]="isArchivePanelOpen()"
  (closed)="closeArchivePanel()"
  (itemRestored)="onArchiveItemRestored()"
></app-archive-panel>
